## 專案名稱

N8N 備份還原工具（N8N Backup & Restore Tool）

## 文件目的與讀者
本文件定義系統之需求、範圍、流程、API、資料結構與驗收準則，供開發、測試、維運與產品利害關係人共同遵循。

## 背景與目標
- 使用者需要將 n8n 的 workflows 與 credentials 進行備份與還原，並可選擇雲端儲存（GitHub、Google Drive）。
- 需支援跨環境操作（如本地、Zeabur、Staging 等），並提供類似 n8n 的直觀 UI。

### 目標
- 便捷地備份/還原全部或部分 workflows、credentials。
- 提供 JWT 登入保護與權限控管。
- 提供跨環境同步（備份來源 → 雲端 → 還原至目標）。
- 介面清晰、可在桌面與行動裝置使用。

## 名詞定義
- Workflow：n8n 的工作流程。
- Credential：n8n 的憑證/連線設定。
- 來源環境/目標環境：對應一組 N8N_BASE_URL 與 N8N_API_KEY 的 n8n 實例。

## 範圍
### 在範圍內
- 使用者登入/驗證（JWT）。
- 列出、選擇並備份 workflows 與 credentials。
- 將備份上傳至 GitHub 或 Google Drive。
- 從 GitHub 或 Google Drive 列表選擇備份並還原。
- 跨環境的備份與還原操作（來源/目標環境切換）。
- 智能關聯：選 workflow 時自動勾選相關 credentials。

### 不在範圍內（現階段）
- 多租戶與多角色權限模型（除基本登入門檻外）。
- 自動排程備份（可作為後續擴充）。
- 完整審計日誌與行為追蹤（目前僅基本伺服器日誌）。

## 使用者與角色
- 一般使用者：登入後可做備份/還原/跨環境操作。
- 系統管理者：同一般使用者，並負責環境變數、安全金鑰配置與部署。

## 使用者故事與驗收條件
### 登入
- 作為使用者，我可以於登入頁輸入帳密登入系統。
- 驗收：
  - 輸入正確帳密回傳 success: true 與 JWT；錯誤則顯示「Invalid credentials」。
  - 本地儲存 authToken 與 currentUser，重新整理後仍維持登入。

### 備份
- 作為使用者，我可以：
  - 檢視 workflows、credentials 列表與數量。
  - 勾選想備份之項目，或選擇全部。
  - 選擇備份目的地（GitHub/Google Drive），輸入自訂名稱（可選）。
- 驗收：
  - 成功回傳 success: true，顯示通知「備份成功」。
  - 在目的地可看到包含 workflows/credentials 的備份檔案。

### 還原
- 作為使用者，我可以從 GitHub/Google Drive 列出備份，預覽內容並選擇要還原的項目與衝突策略（跳過/覆蓋）。
- 驗收：
  - 成功回傳 success: true 與各項目成功/失敗數。
  - 被選擇的 workflow/credential 於目標 n8n 環境中可查到。

### 跨環境
- 作為使用者，我可以指定來源環境進行備份，並將選擇之項目還原到目標環境，完成「遷移」。
- 驗收：
  - 來源環境連線測試顯示可用（工作流數量回傳）。
  - 還原到目標環境成功，結果與預期一致。

## 功能需求
### 認證（/api/auth）
- 登入：POST /api/auth/login，輸入 username, password。
- 驗證：GET /api/auth/verify，Header Authorization: Bearer <token>。
- JWT 過期時間：24 小時。
- 帳號清單：系統內建（可擴充為資料庫）。目前內建：
  - admin / password
  - albouwu@gmail.com / FI@600828
  - 常見別名：albuwu@gmail.com、albowu@gmail.com（相同密碼）

### n8n 資料讀取（/api/n8n）
- GET /api/n8n/workflows?env=<id>：回傳 workflows 陣列、relatedCredentialIds 等衍生欄位。
- GET /api/n8n/credentials?env=<id>：回傳 credentials 陣列。
- POST /api/n8n/test-connection：測試某環境是否可連線（回傳 workflowCount）。

### 備份（/api/backup）
- POST /api/backup/github
- POST /api/backup/googledrive
- GET /api/backup/<source>/list：列出備份清單（名稱、大小、時間）。

### 還原（/api/restore）
- GET /api/restore/<source>/preview/:id：預覽備份內容。
- POST /api/restore/<source>：還原選定項目，支援 restoreMode=skip|overwrite。

### 跨環境（/api/cross-env）
- GET /api/cross-env/environments：列出定義好的 n8n 環境。
- POST /api/cross-env/test-connection：測試環境可用性。
- POST /api/cross-env/backup-from/:sourceEnvId：自來源環境匯出所選項目並備份至目的地。
- POST /api/cross-env/restore-to/:targetEnvId：將備份內容還原至目標環境。

## 非功能需求
### 安全性
- 受保護 API 需 Authorization: Bearer <token>。
- JWT 祕鑰從環境變數 JWT_SECRET 取得；未設定時，開發模式採用預設值（僅本機）。
- credentials 備份以 AES-256 加密（ENCRYPTION_KEY 長度 32 字元）。

### 效能
- 列表載入可逐步優化分批或快取（目前一次載入）。

### 可用性
- UI 響應式、通知清楚（成功/失敗/載入中）。

### 可維護性
- 前後端以 REST 介面分離，public/ 提供靜態頁面與 app.js 操作。
- 路由拆分於 routes/：auth.js、n8n.js、backup.js、restore.js、cross-env.js。

## 系統架構與介面
- 前端：public/ 下的靜態頁（index.html、final-app.html、app.js 等）。
- 後端：Node.js/Express 服務，提供 REST API 與靜態檔案。
- 外部：GitHub、Google Drive、各 n8n 環境 API。

## API 規格摘要
> 詳細請參考 README.md 與 routes/*.js。

### 認證
- POST /api/auth/login → { success: true, token, user } | { error }
- GET /api/auth/verify → { success: true, user } | { error }

### 備份/還原（舉例）
- POST /api/backup/github：Body 含 workflows、credentials、selectedItems、backupName。
- GET /api/backup/github/list：回傳備份清單。
- GET /api/restore/github/preview/:fileName：回傳備份內容摘要。
- POST /api/restore/github：Body 含 selectedItems、restoreMode 等。

## 資料結構（摘要）
{
  "workflow": { "id": number, "name": string, "active": boolean, "relatedCredentialIds": number[] },
  "credential": { "id": number, "name": string, "type": string }
}

## 錯誤處理與通知
- API 失敗回傳 { error: string }，前端以通知區塊顯示。
- 常見錯誤：401（未帶 token 或過期）、403（無效 token）、5xx（外部或伺服器例外）。

## 環境變數（摘要）
PORT=3000
JWT_SECRET=your_jwt_secret_key
ENCRYPTION_KEY=32_chars_encryption_key
N8N_BASE_URL=http://localhost:5678
N8N_API_KEY=your_n8n_api_key
GITHUB_TOKEN=...
GITHUB_REPO_OWNER=...
GITHUB_REPO_NAME=n8n-backups
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REDIRECT_URI=http://localhost:3000/auth/google/callback
GOOGLE_REFRESH_TOKEN=...

## 部署與埠
- 啟動：npm start（PORT 決定埠號；本機常用 3002）。
- 靜態頁提供於 public/；首頁可導向 test.html 或 index.html。

## 測試與驗收（重點）
- 登入流程成功（兩組測試帳密）。
- 列表載入與 n8n 資料相符。
- 勾選 workflow 時自動勾選關聯 credentials。
- 成功備份到 GitHub/Google Drive 並能被列出。
- 還原可選擇部分項目與衝突策略並成功。
- 跨環境操作從來源至目標可完成。

## 風險與限制
- 依賴外部 API（n8n/GitHub/Google Drive），限流或異常會影響成功率。
- 目前使用內建使用者清單，未串接資料庫；不適合多租戶生產環境。
- 加密金鑰需妥善管理。

## 里程碑（建議）
- M1：登入與基本列表。
- M2：GitHub/Google Drive 備份與還原。
- M3：跨環境操作與預覽、智能關聯。
- M4：錯誤處理硬化、文件與自動化測試。

## 需求追蹤矩陣（摘要）
- 登入/JWT → routes/auth.js、public/app.js。
- 列表載入 → routes/n8n.js、public/app.js。
- 備份 → routes/backup.js、public/app.js。
- 還原 → routes/restore.js、public/app.js。
- 跨環境 → routes/cross-env.js、public/app.js。

## 附錄：預設測試帳號
- admin / password
- albouwu@gmail.com / FI@600828
- albuwu@gmail.com / FI@600828
- albowu@gmail.com / FI@600828
