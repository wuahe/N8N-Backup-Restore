# 憑證數據獲取解決方案

## 🔍 問題分析

你發現備份文件中的憑證只有基本信息，沒有實際的憑證數據內容：

```json
"credentials": [
  {
    "id": "Bq1qF7SerCbYmppI",
    "name": "Google Sheets account",
    "type": "googleSheetsOAuth2Api",
    "usedInWorkflows": 4
    // ❌ 缺少 "data" 字段，沒有實際的憑證數據
  }
]
```

## 🚫 為什麼會這樣？

這是 **N8N 的安全設計**：

1. **API 限制**：N8N API 不允許通過 `/api/v1/credentials/{id}` 獲取敏感的憑證數據
2. **安全考慮**：防止憑證數據被意外洩露或濫用
3. **權限控制**：只有特定的內部操作才能訪問完整的憑證數據

## ✅ 解決方案

我們提供了兩種備份方式：

### 方案 1：API 備份（默認 - 安全）
- **特點**：不包含敏感憑證數據
- **安全性**：⭐⭐⭐⭐⭐ 最高
- **適用場景**：生產環境、跨組織遷移
- **還原方式**：需要使用憑證映射或手動重新配置

### 方案 2：CLI 備份（新增 - 完整）
- **特點**：包含完整的憑證數據
- **安全性**：⭐⭐ 需要謹慎處理
- **適用場景**：個人環境、完整遷移
- **還原方式**：可以直接還原所有憑證數據

## 🛠️ CLI 備份實現

### 技術原理：
使用 N8N 官方 CLI 工具進行導出：
```bash
# 包含憑證數據的導出
npx n8n export:workflow --all --decrypted --pretty

# 不包含憑證數據的導出
npx n8n export:workflow --all --pretty
```

### 新增功能：

1. **備份方式選擇**：
   - API 備份：安全，不含敏感數據
   - CLI 備份：完整，包含憑證數據

2. **安全警告系統**：
   - 選擇 CLI 備份時顯示安全警告
   - 需要用戶明確確認包含憑證數據
   - 提供詳細的風險說明

3. **智能處理**：
   - 自動檢測 N8N CLI 是否可用
   - 提供清晰的錯誤信息和解決建議

## 📋 使用指南

### 使用 CLI 備份獲取完整憑證數據：

1. **選擇備份方式**：
   - 在備份界面選擇「CLI 備份」
   - 系統會顯示安全警告

2. **確認包含憑證數據**：
   - 勾選「包含憑證數據」選項
   - 確認安全警告對話框

3. **執行備份**：
   - 系統使用 N8N CLI 進行導出
   - 生成包含完整憑證數據的備份文件

4. **備份文件結構**：
   ```json
   {
     "timestamp": "2025-08-12T...",
     "version": "1.0",
     "workflows": [...],  // 包含完整的憑證數據
     "credentials": [],   // CLI 導出時憑證數據在工作流中
     "exportMethod": "cli",
     "includesCredentialData": true
   }
   ```

### 還原 CLI 備份：

1. **自動檢測**：系統會自動檢測備份是否包含憑證數據
2. **直接還原**：可以直接還原所有憑證，無需映射
3. **安全提示**：會提醒用戶備份包含敏感數據

## ⚠️ 安全注意事項

### CLI 備份的風險：
- **敏感數據洩露**：包含 OAuth tokens、API keys、密碼等
- **權限濫用**：憑證可能具有高級權限
- **合規問題**：可能違反組織安全政策

### 最佳實踐：
1. **僅在必要時使用**：只在需要完整遷移時使用 CLI 備份
2. **安全存儲**：確保備份文件存儲在安全位置
3. **及時清理**：使用後及時刪除包含敏感數據的備份文件
4. **權限控制**：限制對備份文件的訪問權限
5. **定期審查**：定期檢查和更新憑證

## 🎯 使用建議

### 不同場景的推薦方案：

| 場景 | 推薦方案 | 原因 |
|------|----------|------|
| 個人開發環境遷移 | CLI 備份 | 可以完整保留所有配置 |
| 生產環境備份 | API 備份 | 最高安全性 |
| 跨組織遷移 | API 備份 + 映射 | 避免憑證洩露 |
| 災難恢復 | CLI 備份（臨時） | 快速完整恢復 |
| 定期備份 | API 備份 | 日常安全備份 |

## 🔧 技術實現

### 後端新增：
- `/api/backup/cli-export` 端點
- N8N CLI 集成
- 安全警告和確認機制

### 前端新增：
- 備份方式選擇界面
- 安全警告提示
- CLI 備份進度指示

## 結論

現在你有兩種選擇：

1. **需要完整憑證數據**：使用 CLI 備份方式
2. **注重安全性**：使用 API 備份 + 憑證映射

CLI 備份可以解決你提到的「憑證沒內容」問題，但需要謹慎處理安全風險。建議在安全的環境中使用，並及時清理敏感數據。