# 敏感憑證自動處理方案

## 概述

為了解決 Google Sheets API 憑證等敏感憑證的自動還原問題，我們提供了多種處理方案，讓用戶可以根據安全需求和使用場景選擇合適的方式。

## 🔐 方案選項

### 方案 1：跳過敏感憑證（默認 - 最安全）
- **行為**：自動跳過所有敏感憑證
- **安全性**：⭐⭐⭐⭐⭐ 最高
- **便利性**：⭐⭐ 需要手動重新配置
- **適用場景**：生產環境、跨組織還原

### 方案 2：憑證映射（推薦）
- **行為**：將備份中的敏感憑證映射到目標環境中的現有憑證
- **安全性**：⭐⭐⭐⭐ 高
- **便利性**：⭐⭐⭐⭐ 一次配置，多次使用
- **適用場景**：同組織內不同環境間的還原

### 方案 3：強制還原（高風險）
- **行為**：直接還原敏感憑證的所有數據
- **安全性**：⭐⭐ 低
- **便利性**：⭐⭐⭐⭐⭐ 完全自動
- **適用場景**：僅限安全的測試環境

## 🛠️ 實現功能

### 1. 自動檢測敏感憑證
系統會自動識別以下類型的敏感憑證：
- `googleSheetsOAuth2Api` - Google Sheets
- `googleDriveOAuth2Api` - Google Drive  
- `gmailOAuth2` - Gmail
- `slackOAuth2Api` - Slack
- `microsoftGraphOAuth2Api` - Microsoft Graph
- `githubOAuth2Api` - GitHub
- 其他 OAuth2 類型憑證

### 2. 智能處理選項
在還原界面中，當檢測到敏感憑證時，系統會：
- 顯示敏感憑證警告標識
- 提供三種處理模式選擇
- 根據選擇的模式顯示相應的配置選項

### 3. 憑證映射功能
- **自動預填充**：系統會自動為檢測到的敏感憑證創建映射項目
- **手動配置**：用戶可以添加、編輯、刪除映射關係
- **智能建議**：系統可以檢測目標環境中的可用憑證並提供建議
- **配置保存**：映射配置會保存在本地，方便重複使用

### 4. 安全警告系統
- **視覺提示**：敏感憑證會有特殊的視覺標識
- **風險警告**：選擇強制還原時會顯示明確的安全警告
- **操作確認**：高風險操作需要用戶明確確認

## 📋 使用指南

### 使用憑證映射（推薦）

1. **準備工作**：
   - 在目標 N8N 環境中創建所需的憑證
   - 記錄憑證的 ID 和名稱

2. **配置映射**：
   - 在還原界面選擇「使用憑證映射」
   - 系統會自動為敏感憑證創建映射項目
   - 填入目標環境中對應憑證的 ID

3. **執行還原**：
   - 系統會將備份中的憑證引用替換為映射的憑證 ID
   - 工作流會自動連接到目標環境中的憑證

### 環境變數配置

可以通過環境變數控制默認行為：

```bash
# 啟用自動還原敏感憑證（不推薦用於生產環境）
AUTO_RESTORE_SENSITIVE_CREDENTIALS=true
```

### API 參數

還原 API 支持以下新參數：

```javascript
{
  "restoreMode": "force_all",  // 強制還原模式
  "credentialMapping": {       // 憑證映射
    "old-credential-id": "new-credential-id"
  }
}
```

## 🔧 技術實現

### 後端修改

1. **敏感憑證檢測**：
   ```javascript
   const sensitiveTypes = [
     'googleSheetsOAuth2Api', 'googleDriveOAuth2Api', 'gmailOAuth2',
     // ... 其他敏感類型
   ];
   const isSensitive = sensitiveTypes.includes(credential.type);
   ```

2. **憑證映射處理**：
   ```javascript
   const mappedCredentialId = credentialMapping[credentialId];
   if (mappedCredentialId) {
     // 使用映射的憑證 ID
     return { action: 'mapped', mappedTo: mappedCredentialId };
   }
   ```

3. **強制還原支持**：
   ```javascript
   const autoRestoreSensitive = restoreMode === 'force_all';
   if (isSensitive && !autoRestoreSensitive) {
     // 跳過敏感憑證
   }
   ```

### 前端修改

1. **敏感憑證檢測和標識**
2. **處理模式選擇界面**
3. **憑證映射配置界面**
4. **安全警告和確認機制**

## ⚠️ 安全注意事項

### 強制還原的風險
- **憑證洩露**：敏感憑證可能包含有效的訪問令牌
- **權限濫用**：還原的憑證可能具有過高的權限
- **合規問題**：可能違反組織的安全政策

### 最佳實踐
1. **生產環境**：始終使用「跳過敏感憑證」模式
2. **測試環境**：可以使用憑證映射或強制還原
3. **跨組織**：絕不使用強制還原模式
4. **定期審查**：定期檢查和更新憑證映射配置

## 🎯 使用建議

### 不同場景的推薦方案

| 場景 | 推薦方案 | 原因 |
|------|----------|------|
| 生產環境還原 | 跳過敏感憑證 | 最高安全性 |
| 開發/測試環境 | 憑證映射 | 平衡安全性和便利性 |
| 同一組織內部 | 憑證映射 | 可重複使用配置 |
| 跨組織遷移 | 跳過敏感憑證 | 避免憑證洩露 |
| 緊急恢復 | 憑證映射 | 快速恢復服務 |

## 結論

通過提供多種敏感憑證處理方案，我們既保證了系統的安全性，又提供了足夠的靈活性來滿足不同的使用需求。用戶可以根據自己的安全要求和使用場景選擇最合適的方案。