<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—œè¯é¸æ“‡æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; gap: 20px; }
        .section { flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .item { padding: 8px; border-bottom: 1px solid #eee; }
        .item:last-child { border-bottom: none; }
        .auto-selected { background: #e8f5e8; border-left: 3px solid #4caf50; }
        .auto-selected .name::after { content: " (è‡ªå‹•é¸ä¸­)"; color: #4caf50; font-size: 12px; }
        h3 { margin-top: 0; }
        input[type="checkbox"] { margin-right: 8px; }
        .name { font-weight: bold; }
        .details { font-size: 12px; color: #666; margin-top: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ¯ N8N æ™ºèƒ½é—œè¯é¸æ“‡åŠŸèƒ½æ¸¬è©¦</h1>
    <p>ç•¶ä½ å‹¾é¸å·¦é‚Šçš„ Workflow æ™‚ï¼Œå³é‚Šç›¸é—œçš„ Credentials æœƒè‡ªå‹•è¢«å‹¾é¸ã€‚</p>
    
    <div class="container">
        <div class="section">
            <h3>ğŸ“‹ Workflows</h3>
            <div id="workflows-list">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="section">
            <h3>ğŸ”‘ Credentials</h3>
            <div id="credentials-list">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script>
        let workflows = [];
        let credentials = [];

        // è¼‰å…¥æ•¸æ“š
        async function loadData() {
            try {
                const [workflowsRes, credentialsRes] = await Promise.all([
                    fetch('/api/n8n/workflows'),
                    fetch('/api/n8n/credentials')
                ]);
                
                workflows = await workflowsRes.json();
                credentials = await credentialsRes.json();
                
                renderWorkflows();
                renderCredentials();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // æ¸²æŸ“ workflows
        function renderWorkflows() {
            const container = document.getElementById('workflows-list');
            container.innerHTML = workflows.slice(0, 10).map(workflow => `
                <div class="item">
                    <label>
                        <input type="checkbox" 
                               value="${workflow.id}" 
                               data-related-credentials="${(workflow.relatedCredentialIds || []).join(',')}"
                               onchange="handleWorkflowSelection(this)">
                        <div class="name">${workflow.name}</div>
                        <div class="details">
                            ç›¸é—œæ†‘è­‰: ${workflow.relatedCredentials ? workflow.relatedCredentials.length : 0} å€‹
                            ${workflow.relatedCredentials ? workflow.relatedCredentials.map(c => c.name).join(', ') : ''}
                        </div>
                    </label>
                </div>
            `).join('');
        }

        // æ¸²æŸ“ credentials
        function renderCredentials() {
            const container = document.getElementById('credentials-list');
            container.innerHTML = credentials.map(credential => `
                <div class="item" id="credential-item-${credential.id}">
                    <label>
                        <input type="checkbox" id="credential-${credential.id}" value="${credential.id}">
                        <div class="name">${credential.name}</div>
                        <div class="details">é¡å‹: ${credential.type}</div>
                    </label>
                </div>
            `).join('');
        }

        // è™•ç† workflow é¸æ“‡
        function handleWorkflowSelection(workflowCheckbox) {
            const isChecked = workflowCheckbox.checked;
            const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
            
            if (relatedCredentialIds) {
                const credentialIds = relatedCredentialIds.split(',').filter(id => id.trim());
                
                credentialIds.forEach(credentialId => {
                    const credentialCheckbox = document.getElementById(`credential-${credentialId}`);
                    const credentialItem = document.getElementById(`credential-item-${credentialId}`);
                    
                    if (credentialCheckbox && credentialItem) {
                        if (isChecked) {
                            credentialCheckbox.checked = true;
                            credentialItem.classList.add('auto-selected');
                        } else {
                            const stillNeeded = isCredentialStillNeeded(credentialId);
                            if (!stillNeeded) {
                                credentialCheckbox.checked = false;
                                credentialItem.classList.remove('auto-selected');
                            }
                        }
                    }
                });
            }
        }

        // æª¢æŸ¥ credential æ˜¯å¦é‚„è¢«å…¶ä»–å·²é¸ä¸­çš„ workflow éœ€è¦
        function isCredentialStillNeeded(credentialId) {
            const selectedWorkflows = document.querySelectorAll('input[type="checkbox"]:checked[data-related-credentials]');
            
            for (const workflowCheckbox of selectedWorkflows) {
                const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
                if (relatedCredentialIds && relatedCredentialIds.split(',').includes(credentialId)) {
                    return true;
                }
            }
            
            return false;
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        loadData();
    </script>
</body>
</html>