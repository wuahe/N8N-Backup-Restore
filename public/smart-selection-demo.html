<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能關聯選擇 - 演示</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .demo-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }
        
        .demo-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .feature-card h3 {
            color: #ff6d5a;
            margin-bottom: 10px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feature-list li::before {
            content: "✓";
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1><i class="fas fa-magic"></i> 智能關聯選擇功能演示</h1>
            <p>體驗增強的 workflow 和 credential 智能關聯選擇功能</p>
        </div>

        <div class="demo-features">
            <div class="feature-card">
                <h3><i class="fas fa-link"></i> 智能關聯</h3>
                <ul class="feature-list">
                    <li>勾選 workflow 自動選中相關憑證</li>
                    <li>取消勾選時智能判斷是否保留憑證</li>
                    <li>視覺化顯示關聯關係</li>
                    <li>動畫效果提升用戶體驗</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3><i class="fas fa-eye"></i> 視覺提示</h3>
                <ul class="feature-list">
                    <li>滑鼠懸停高亮相關憑證</li>
                    <li>自動選中項目特殊標記</li>
                    <li>關聯數量指示器</li>
                    <li>選擇狀態實時摘要</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3><i class="fas fa-cog"></i> 靈活控制</h3>
                <ul class="feature-list">
                    <li>可切換智能關聯開關</li>
                    <li>支援鍵盤快捷鍵操作</li>
                    <li>全選/取消全選功能</li>
                    <li>選擇計數實時更新</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3><i class="fas fa-keyboard"></i> 快捷鍵</h3>
                <ul class="feature-list">
                    <li>Ctrl+S: 切換智能關聯</li>
                    <li>Shift+Ctrl+A: 全選 workflows</li>
                    <li>Ctrl+D: 清除所有選擇</li>
                    <li>提升操作效率</li>
                </ul>
            </div>
        </div>

        <div class="backup-container">
            <div class="backup-settings">
                <div class="form-group">
                    <label for="backupName">備份名稱</label>
                    <input type="text" id="backupName" placeholder="智能關聯演示備份">
                </div>
                <div class="form-group">
                    <label for="backupDestination">備份目標</label>
                    <select id="backupDestination">
                        <option value="github">GitHub</option>
                        <option value="googledrive">Google Drive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="smart-toggle-label">
                        <input type="checkbox" id="smartSelectionToggle" checked>
                        <span class="toggle-slider"></span>
                        智能關聯選擇
                    </label>
                    <small class="form-help">
                        自動選中 workflow 相關的憑證
                        <br>
                        <span class="keyboard-shortcuts">
                            快捷鍵: Ctrl+S 切換 | Shift+Ctrl+A 全選 | Ctrl+D 清除
                        </span>
                    </small>
                </div>
            </div>

            <div class="items-selection">
                <div class="selection-section">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-project-diagram"></i>
                            Workflows
                            <span class="item-count" id="workflowCount">3</span>
                        </h3>
                        <div class="selection-controls">
                            <button class="btn btn-sm" id="selectAllWorkflows">全選</button>
                            <button class="btn btn-sm" id="deselectAllWorkflows">取消全選</button>
                        </div>
                    </div>
                    <div class="items-list" id="workflowsList">
                        <!-- 演示數據 -->
                        <div class="item-checkbox workflow-item" id="workflow-item-1"
                             onmouseenter="highlightRelatedCredentials('1', true)"
                             onmouseleave="highlightRelatedCredentials('1', false)">
                            <input type="checkbox" id="workflow-1" value="1" data-type="workflow"
                                   data-related-credentials="1,2"
                                   onchange="handleWorkflowSelection(this)">
                            <div class="item-info">
                                <div class="item-name">
                                    用戶註冊流程
                                    <span class="related-indicator" title="此 workflow 使用了 2 個憑證">🔗2</span>
                                </div>
                                <div class="item-details">
                                    <span class="item-status status-active">
                                        <i class="fas fa-play"></i>
                                        啟用
                                    </span>
                                    <span class="item-tag">用戶管理</span>
                                    <span class="related-credentials-info">相關憑證: 2</span>
                                </div>
                            </div>
                        </div>

                        <div class="item-checkbox workflow-item" id="workflow-item-2"
                             onmouseenter="highlightRelatedCredentials('2', true)"
                             onmouseleave="highlightRelatedCredentials('2', false)">
                            <input type="checkbox" id="workflow-2" value="2" data-type="workflow"
                                   data-related-credentials="2,3"
                                   onchange="handleWorkflowSelection(this)">
                            <div class="item-info">
                                <div class="item-name">
                                    郵件通知系統
                                    <span class="related-indicator" title="此 workflow 使用了 2 個憑證">🔗2</span>
                                </div>
                                <div class="item-details">
                                    <span class="item-status status-active">
                                        <i class="fas fa-play"></i>
                                        啟用
                                    </span>
                                    <span class="item-tag">通知</span>
                                    <span class="related-credentials-info">相關憑證: 2</span>
                                </div>
                            </div>
                        </div>

                        <div class="item-checkbox workflow-item" id="workflow-item-3"
                             onmouseenter="highlightRelatedCredentials('3', true)"
                             onmouseleave="highlightRelatedCredentials('3', false)">
                            <input type="checkbox" id="workflow-3" value="3" data-type="workflow"
                                   data-related-credentials="1"
                                   onchange="handleWorkflowSelection(this)">
                            <div class="item-info">
                                <div class="item-name">
                                    數據同步任務
                                    <span class="related-indicator" title="此 workflow 使用了 1 個憑證">🔗1</span>
                                </div>
                                <div class="item-details">
                                    <span class="item-status status-inactive">
                                        <i class="fas fa-pause"></i>
                                        停用
                                    </span>
                                    <span class="item-tag">數據處理</span>
                                    <span class="related-credentials-info">相關憑證: 1</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="selection-section">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-key"></i>
                            Credentials
                            <span class="item-count" id="credentialCount">3</span>
                        </h3>
                        <div class="selection-controls">
                            <button class="btn btn-sm" id="selectAllCredentials">全選</button>
                            <button class="btn btn-sm" id="deselectAllCredentials">取消全選</button>
                        </div>
                    </div>
                    <div class="items-list" id="credentialsList">
                        <!-- 演示數據 -->
                        <div class="item-checkbox" id="credential-item-1">
                            <input type="checkbox" id="credential-1" value="1" data-type="credential">
                            <div class="item-info">
                                <div class="item-name">資料庫連接</div>
                                <div class="item-details">
                                    <span>類型: MySQL</span>
                                </div>
                            </div>
                        </div>

                        <div class="item-checkbox" id="credential-item-2">
                            <input type="checkbox" id="credential-2" value="2" data-type="credential">
                            <div class="item-info">
                                <div class="item-name">SMTP 郵件服務</div>
                                <div class="item-details">
                                    <span>類型: SMTP</span>
                                </div>
                            </div>
                        </div>

                        <div class="item-checkbox" id="credential-item-3">
                            <input type="checkbox" id="credential-3" value="3" data-type="credential">
                            <div class="item-info">
                                <div class="item-name">API 金鑰</div>
                                <div class="item-details">
                                    <span>類型: HTTP Header Auth</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 智能選擇摘要 -->
            <div class="selection-summary" id="selectionSummary" style="display: none;">
                <div class="summary-header">
                    <h4><i class="fas fa-magic"></i> 智能選擇摘要</h4>
                </div>
                <div class="summary-content">
                    <div class="summary-item">
                        <span class="summary-label">已選 Workflows:</span>
                        <span class="summary-value" id="selectedWorkflowsCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">已選 Credentials:</span>
                        <span class="summary-value" id="selectedCredentialsCount">0</span>
                        <span class="auto-selected-count" id="autoSelectedCount">(0 個自動選中)</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">總計:</span>
                        <span class="summary-value total" id="totalSelectedCount">0</span>
                    </div>
                </div>
            </div>

            <div class="backup-actions">
                <button id="startBackupBtn" class="btn btn-primary btn-large" disabled>
                    <i class="fas fa-upload"></i>
                    開始備份
                </button>
            </div>
        </div>

        <!-- 通知容器 -->
        <div id="notifications" class="notifications"></div>
    </div>

    <script>
        // 模擬數據
        let workflows = [
            { id: '1', name: '用戶註冊流程', active: true, tags: ['用戶管理'], relatedCredentialIds: ['1', '2'] },
            { id: '2', name: '郵件通知系統', active: true, tags: ['通知'], relatedCredentialIds: ['2', '3'] },
            { id: '3', name: '數據同步任務', active: false, tags: ['數據處理'], relatedCredentialIds: ['1'] }
        ];

        let credentials = [
            { id: '1', name: '資料庫連接', type: 'MySQL' },
            { id: '2', name: 'SMTP 郵件服務', type: 'SMTP' },
            { id: '3', name: 'API 金鑰', type: 'HTTP Header Auth' }
        ];

        // 複製主應用的智能關聯功能
        function handleWorkflowSelection(workflowCheckbox) {
            const isChecked = workflowCheckbox.checked;
            const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
            
            const smartToggle = document.getElementById('smartSelectionToggle');
            const smartSelectionEnabled = smartToggle ? smartToggle.checked : true;
            
            if (!relatedCredentialIds || !smartSelectionEnabled) {
                updateSelectionCounts();
                return;
            }

            const credentialIds = relatedCredentialIds.split(',').filter(id => id.trim());
            
            credentialIds.forEach(credentialId => {
                const credentialCheckbox = document.getElementById(`credential-${credentialId}`);
                const credentialItem = document.getElementById(`credential-item-${credentialId}`);
                
                if (!credentialCheckbox) return;

                if (isChecked) {
                    credentialCheckbox.checked = true;
                    if (credentialItem) {
                        credentialItem.classList.add('auto-selected');
                        credentialItem.style.animation = 'highlightAutoSelect 0.5s ease';
                        setTimeout(() => {
                            credentialItem.style.animation = '';
                        }, 500);
                    }
                } else {
                    const stillNeeded = isCredentialStillNeeded(credentialId);
                    if (!stillNeeded) {
                        credentialCheckbox.checked = false;
                        if (credentialItem) {
                            credentialItem.classList.remove('auto-selected');
                            credentialItem.style.animation = 'highlightAutoDeselect 0.5s ease';
                            setTimeout(() => {
                                credentialItem.style.animation = '';
                            }, 500);
                        }
                    }
                }
            });
            
            if (credentialIds.length > 0) {
                const action = isChecked ? '選中' : '取消選中';
                showSmartSelectionNotification(`已自動${action}相關憑證`, 'info');
            }
            
            updateSelectionCounts();
        }

        function isCredentialStillNeeded(credentialId) {
            const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked');
            for (const wf of selectedWorkflows) {
                const ids = (wf.dataset.relatedCredentials || '').split(',');
                if (ids.includes(credentialId)) return true;
            }
            return false;
        }

        function highlightRelatedCredentials(workflowId, highlight) {
            const workflowCheckbox = document.getElementById(`workflow-${workflowId}`);
            if (!workflowCheckbox) return;
            
            const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
            if (!relatedCredentialIds) return;
            
            const credentialIds = relatedCredentialIds.split(',').filter(id => id.trim());
            
            credentialIds.forEach(credentialId => {
                const credentialItem = document.getElementById(`credential-item-${credentialId}`);
                if (credentialItem) {
                    if (highlight) {
                        credentialItem.classList.add('related-highlight');
                    } else {
                        credentialItem.classList.remove('related-highlight');
                    }
                }
            });
        }

        function updateSelectionCounts() {
            const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked').length;
            const selectedCredentials = document.querySelectorAll('input[data-type="credential"]:checked').length;
            const autoSelectedCredentials = document.querySelectorAll('.item-checkbox.auto-selected input:checked').length;
            
            const summaryPanel = document.getElementById('selectionSummary');
            const selectedWorkflowsCountEl = document.getElementById('selectedWorkflowsCount');
            const selectedCredentialsCountEl = document.getElementById('selectedCredentialsCount');
            const autoSelectedCountEl = document.getElementById('autoSelectedCount');
            const totalSelectedCountEl = document.getElementById('totalSelectedCount');
            
            if (summaryPanel && selectedWorkflowsCountEl && selectedCredentialsCountEl && autoSelectedCountEl && totalSelectedCountEl) {
                const totalSelected = selectedWorkflows + selectedCredentials;
                
                if (totalSelected > 0) {
                    summaryPanel.style.display = 'block';
                    selectedWorkflowsCountEl.textContent = selectedWorkflows;
                    selectedCredentialsCountEl.textContent = selectedCredentials;
                    autoSelectedCountEl.textContent = `(${autoSelectedCredentials} 個自動選中)`;
                    totalSelectedCountEl.textContent = totalSelected;
                } else {
                    summaryPanel.style.display = 'none';
                }
            }
            
            const backupBtn = document.getElementById('startBackupBtn');
            if (backupBtn) {
                const totalSelected = selectedWorkflows + selectedCredentials;
                if (totalSelected > 0) {
                    backupBtn.innerHTML = `<i class="fas fa-upload"></i> 開始備份 (${selectedWorkflows} 個 Workflows, ${selectedCredentials} 個 Credentials)`;
                    backupBtn.disabled = false;
                    backupBtn.classList.add('ready');
                } else {
                    backupBtn.innerHTML = `<i class="fas fa-upload"></i> 開始備份`;
                    backupBtn.disabled = true;
                    backupBtn.classList.remove('ready');
                }
            }
        }

        function selectAllWorkflows(select) {
            const checkboxes = document.querySelectorAll('input[data-type="workflow"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
                handleWorkflowSelection(checkbox);
            });
        }

        function selectAllCredentials(select) {
            const checkboxes = document.querySelectorAll('input[data-type="credential"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
                const credentialItem = document.getElementById(`credential-item-${checkbox.value}`);
                if (credentialItem && !select) {
                    credentialItem.classList.remove('auto-selected');
                }
            });
            updateSelectionCounts();
        }

        function handleSmartToggleChange() {
            const smartToggle = document.getElementById('smartSelectionToggle');
            const isEnabled = smartToggle.checked;
            
            if (!isEnabled) {
                document.querySelectorAll('.item-checkbox.auto-selected').forEach(item => {
                    item.classList.remove('auto-selected');
                });
                showSmartSelectionNotification('智能關聯已關閉', 'info');
            } else {
                const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked');
                selectedWorkflows.forEach(workflowCheckbox => {
                    handleWorkflowSelection(workflowCheckbox);
                });
                showSmartSelectionNotification('智能關聯已開啟', 'info');
            }
            
            updateSelectionCounts();
        }

        function showSmartSelectionNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `smart-notification ${type}`;
            notification.textContent = message;
            
            const container = document.getElementById('notifications');
            if (container) {
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        notification.remove();
                    }, 200);
                }, 1500);
            }
        }

        function handleKeyboardShortcuts(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const smartToggle = document.getElementById('smartSelectionToggle');
                if (smartToggle) {
                    smartToggle.checked = !smartToggle.checked;
                    handleSmartToggleChange();
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.shiftKey) {
                e.preventDefault();
                selectAllWorkflows(true);
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                selectAllWorkflows(false);
                selectAllCredentials(false);
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 設置事件監聽器
            document.getElementById('selectAllWorkflows').addEventListener('click', () => selectAllWorkflows(true));
            document.getElementById('deselectAllWorkflows').addEventListener('click', () => selectAllWorkflows(false));
            document.getElementById('selectAllCredentials').addEventListener('click', () => selectAllCredentials(true));
            document.getElementById('deselectAllCredentials').addEventListener('click', () => selectAllCredentials(false));
            document.getElementById('smartSelectionToggle').addEventListener('change', handleSmartToggleChange);
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // 初始化計數
            updateSelectionCounts();
        });
    </script>
</body>
</html>