<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8N Backup & Restore Tool</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- ç™»å…¥é é¢ -->
        <div id="loginPage" class="page">
            <div class="login-container">
                <div class="login-form">
                    <h2><i class="fas fa-shield-alt"></i> N8N Backup & Restore</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="username">ç”¨æˆ¶å</label>
                            <input type="text" id="username" name="username" value="albouwu@gmail.com" required>
                        </div>
                        <div class="form-group">
                            <label for="password">å¯†ç¢¼</label>
                            <input type="password" id="password" name="password" value="FI@600828" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> ç™»å…¥
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ä¸»é é¢ -->
        <div id="mainPage" class="page hidden">
            <!-- é ‚éƒ¨å°èˆª -->
            <nav class="navbar">
                <div class="nav-brand">
                    <i class="fas fa-database"></i>
                    N8N Backup & Restore
                </div>
                <div class="nav-actions">
                    <span class="user-info">
                        <i class="fas fa-user"></i>
                        <span id="currentUser">ç”¨æˆ¶</span>
                    </span>
                    <button id="logoutBtn" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                    </button>
                </div>
            </nav>

            <!-- ä¸»è¦å…§å®¹ -->
            <div class="main-content">
                <!-- å´é‚Šæ¬„ -->
                <aside class="sidebar">
                    <div class="sidebar-menu">
                        <button class="menu-item active" data-tab="backup">
                            <i class="fas fa-upload"></i>
                            <span>å‚™ä»½</span>
                        </button>
                        <button class="menu-item" data-tab="restore">
                            <i class="fas fa-download"></i>
                            <span>é‚„åŸ</span>
                        </button>
                        <button class="menu-item" data-tab="history">
                            <i class="fas fa-history"></i>
                            <span>å‚™ä»½æ­·å²</span>
                        </button>
                        <button class="menu-item" data-tab="cross-env">
                            <i class="fas fa-exchange-alt"></i>
                            <span>è·¨ç’°å¢ƒ</span>
                        </button>
                    </div>
                </aside>

                <!-- å…§å®¹å€åŸŸ -->
                <main class="content">
                    <!-- å‚™ä»½é é¢ -->
                    <div id="backupTab" class="tab-content active">
                        <div class="content-header">
                            <h2><i class="fas fa-upload"></i> å‚™ä»½ Workflows å’Œ Credentials</h2>
                            <button id="refreshDataBtn" class="btn btn-outline">
                                <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                            </button>
                        </div>

                        <div class="backup-container">
                            <div class="backup-settings">
                                <div class="form-group">
                                    <label for="backupName">å‚™ä»½åç¨±</label>
                                    <input type="text" id="backupName" placeholder="è¼¸å…¥å‚™ä»½åç¨±ï¼ˆå¯é¸ï¼‰">
                                </div>
                                <div class="form-group">
                                    <label for="backupDestination">å‚™ä»½ç›®æ¨™</label>
                                    <select id="backupDestination">
                                        <option value="github">GitHub</option>
                                        <option value="googledrive">Google Drive</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="backupMethod">å‚™ä»½æ–¹å¼</label>
                                    <select id="backupMethod" onchange="handleBackupMethodChange()">
                                        <option value="api">API å‚™ä»½ï¼ˆå®‰å…¨ï¼Œä¸å«æ•æ„Ÿæ†‘è­‰æ•¸æ“šï¼‰</option>
                                        <option value="cli">CLI å‚™ä»½ï¼ˆåŒ…å«å®Œæ•´æ†‘è­‰æ•¸æ“šï¼‰</option>
                                    </select>
                                    <small class="form-help">CLI å‚™ä»½éœ€è¦ N8N CLI å·¥å…·ï¼Œå¯ä»¥åŒ…å«å®Œæ•´çš„æ†‘è­‰æ•¸æ“š</small>
                                </div>
                                
                                <div class="credential-data-warning" id="credentialDataWarning" style="display: none;">
                                    <div class="warning-box">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>æ³¨æ„ï¼š</strong>CLI å‚™ä»½æœƒåŒ…å«å®Œæ•´çš„æ†‘è­‰æ•¸æ“šï¼ˆåŒ…æ‹¬ tokensã€å¯†ç¢¼ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚
                                        è«‹ç¢ºä¿å‚™ä»½æ–‡ä»¶çš„å®‰å…¨æ€§ï¼Œå»ºè­°åƒ…åœ¨å®‰å…¨ç’°å¢ƒä¸­ä½¿ç”¨ã€‚
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="includeCredentialData">
                                            åŒ…å«æ†‘è­‰æ•¸æ“šï¼ˆâš ï¸ é«˜é¢¨éšªï¼‰
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="smart-toggle-label">
                                        <input type="checkbox" id="smartSelectionToggle" checked>
                                        <span class="toggle-slider"></span>
                                        æ™ºèƒ½é—œè¯é¸æ“‡
                                    </label>
                                    <small class="form-help">
                                        è‡ªå‹•é¸ä¸­ workflow ç›¸é—œçš„æ†‘è­‰
                                        <br>
                                        <span class="keyboard-shortcuts">
                                            å¿«æ·éµ: Ctrl+S åˆ‡æ› | Shift+Ctrl+A å…¨é¸ | Ctrl+D æ¸…é™¤
                                        </span>
                                    </small>
                                </div>
                            </div>

                            <div class="items-selection">
                                <div class="selection-section">
                                    <div class="section-header">
                                        <h3>
                                            <i class="fas fa-project-diagram"></i>
                                            Workflows
                                            <span class="item-count" id="workflowCount">0</span>
                                        </h3>
                                        <div class="selection-controls">
                                            <button class="btn btn-sm" id="selectAllWorkflows">å…¨é¸</button>
                                            <button class="btn btn-sm" id="deselectAllWorkflows">å–æ¶ˆå…¨é¸</button>
                                        </div>
                                    </div>
                                    <div class="items-list" id="workflowsList">
                                        <div style="text-align: center; padding: 20px; color: #666;">
                                            è¼‰å…¥ä¸­...
                                        </div>
                                    </div>
                                </div>

                                <div class="selection-section">
                                    <div class="section-header">
                                        <h3>
                                            <i class="fas fa-key"></i>
                                            Credentials
                                            <span class="item-count" id="credentialCount">0</span>
                                        </h3>
                                        <div class="selection-controls">
                                            <button class="btn btn-sm" id="selectAllCredentials">å…¨é¸</button>
                                            <button class="btn btn-sm" id="deselectAllCredentials">å–æ¶ˆå…¨é¸</button>
                                        </div>
                                    </div>
                                    <div class="items-list" id="credentialsList">
                                        <div style="text-align: center; padding: 20px; color: #666;">
                                            è¼‰å…¥ä¸­...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ™ºèƒ½é¸æ“‡æ‘˜è¦ -->
                            <div class="selection-summary" id="selectionSummary" style="display: none;">
                                <div class="summary-header">
                                    <h4><i class="fas fa-magic"></i> æ™ºèƒ½é¸æ“‡æ‘˜è¦</h4>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-item">
                                        <span class="summary-label">å·²é¸ Workflows:</span>
                                        <span class="summary-value" id="selectedWorkflowsCount">0</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">å·²é¸ Credentials:</span>
                                        <span class="summary-value" id="selectedCredentialsCount">0</span>
                                        <span class="auto-selected-count" id="autoSelectedCount">(0 å€‹è‡ªå‹•é¸ä¸­)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">ç¸½è¨ˆ:</span>
                                        <span class="summary-value total" id="totalSelectedCount">0</span>
                                    </div>
                                </div>
                            </div>

                            <div class="backup-actions">
                                <button id="startBackupBtn" class="btn btn-primary btn-large" disabled>
                                    <i class="fas fa-upload"></i>
                                    é–‹å§‹å‚™ä»½
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- é‚„åŸæ¨™ç±¤é  -->
                    <div id="restoreTab" class="tab-content">
                        <div class="content-header">
                            <h2><i class="fas fa-download"></i> é‚„åŸ Workflows å’Œ Credentials</h2>
                            <button id="refreshBackupsBtn" class="btn btn-outline">
                                <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                            </button>
                        </div>

                        <div class="restore-container">
                            <div class="restore-settings">
                                <div class="form-group">
                                    <label for="restoreSource">é‚„åŸä¾†æº</label>
                                    <select id="restoreSource">
                                        <option value="googledrive">Google Drive</option>
                                        <option value="github">GitHub</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="restoreMode">é‚„åŸæ¨¡å¼</label>
                                    <select id="restoreMode">
                                        <option value="skip">è·³éç¾æœ‰é …ç›®</option>
                                        <option value="overwrite">è¦†è“‹ç¾æœ‰é …ç›®</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="restoreTarget">ç›®æ¨™ç’°å¢ƒ</label>
                                    <select id="restoreTarget">
                                        <option value="default">æœ¬åœ° N8N</option>
                                        <option value="env_a">ç’°å¢ƒ A</option>
                                        <option value="env_b">ç’°å¢ƒ B</option>
                                        <option value="env_c">ç’°å¢ƒ C</option>
                                    </select>
                                </div>
                            </div>

                            <!-- å‚™ä»½åˆ—è¡¨ -->
                            <div class="backups-list">
                                <h3><i class="fas fa-archive"></i> å¯ç”¨çš„å‚™ä»½</h3>
                                <div id="availableBackups">
                                    <div style="text-align: center; padding: 20px; color: #666;">
                                        è¼‰å…¥ä¸­...
                                    </div>
                                </div>
                            </div>

                            <!-- é‚„åŸé …ç›®é¸æ“‡ -->
                            <div class="restore-options hidden" id="restoreOptions">
                                <h3><i class="fas fa-list-check"></i> é¸æ“‡è¦é‚„åŸçš„é …ç›®</h3>
                                <div id="restoreItemsSelection">
                                    <!-- å‹•æ…‹è¼‰å…¥çš„é‚„åŸé …ç›® -->
                                </div>
                                
                                <!-- æ•æ„Ÿæ†‘è­‰è™•ç†é¸é … -->
                                <div class="sensitive-credentials-options" id="sensitiveCredentialsOptions" style="display: none;">
                                    <h4><i class="fas fa-shield-alt"></i> æ•æ„Ÿæ†‘è­‰è™•ç†</h4>
                                    <div class="credential-mode-selection">
                                        <label class="radio-option">
                                            <input type="radio" name="sensitiveCredentialMode" value="skip" checked>
                                            <span>è·³éæ•æ„Ÿæ†‘è­‰ï¼ˆæ¨è–¦ï¼‰</span>
                                            <small>æ•æ„Ÿæ†‘è­‰éœ€è¦æ‰‹å‹•é‡æ–°é…ç½®</small>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="sensitiveCredentialMode" value="map">
                                            <span>ä½¿ç”¨æ†‘è­‰æ˜ å°„</span>
                                            <small>å°‡å‚™ä»½æ†‘è­‰æ˜ å°„åˆ°ç¾æœ‰æ†‘è­‰</small>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="sensitiveCredentialMode" value="force">
                                            <span>âš ï¸ å¼·åˆ¶é‚„åŸï¼ˆé«˜é¢¨éšªï¼‰</span>
                                            <small>ç›´æ¥é‚„åŸæ•æ„Ÿæ†‘è­‰æ•¸æ“š</small>
                                        </label>
                                    </div>
                                    
                                    <div class="credential-mapping-section" id="credentialMappingSection" style="display: none;">
                                        <h5>æ†‘è­‰æ˜ å°„é…ç½®</h5>
                                        <div id="credentialMappingList">
                                            <!-- å‹•æ…‹ç”Ÿæˆçš„æ˜ å°„é …ç›® -->
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline" onclick="addCredentialMapping()">
                                            <i class="fas fa-plus"></i> æ·»åŠ æ˜ å°„
                                        </button>
                                    </div>
                                    
                                    <div class="force-warning" id="forceRestoreWarning" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>è­¦å‘Šï¼š</strong>å¼·åˆ¶é‚„åŸæ•æ„Ÿæ†‘è­‰å¯èƒ½å°è‡´å®‰å…¨é¢¨éšªã€‚è«‹ç¢ºä¿åœ¨å®‰å…¨ç’°å¢ƒä¸­æ“ä½œã€‚
                                    </div>
                                </div>
                                
                                <div class="restore-actions">
                                    <button id="startRestoreBtn" class="btn btn-primary btn-large" disabled>
                                        <i class="fas fa-download"></i>
                                        é–‹å§‹é‚„åŸ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="historyTab" class="tab-content">
                        <div class="content-header">
                            <h2><i class="fas fa-history"></i> å‚™ä»½æ­·å²</h2>
                        </div>
                        <div style="text-align: center; padding: 40px;">
                            <p>æ­·å²è¨˜éŒ„åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                        </div>
                    </div>

                    <div id="cross-envTab" class="tab-content">
                        <div class="content-header">
                            <h2><i class="fas fa-exchange-alt"></i> è·¨ç’°å¢ƒå‚™ä»½é‚„åŸ</h2>
                        </div>
                        <div style="text-align: center; padding: 40px;">
                            <p>è·¨ç’°å¢ƒåŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­è¦†è“‹å±¤ -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p id="loadingText">è™•ç†ä¸­...</p>
            </div>
        </div>

        <!-- é€šçŸ¥å®¹å™¨ -->
        <div id="notifications" class="notifications"></div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let currentUser = null;
        let authToken = null;
        let workflows = [];
        let credentials = [];

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // ç²å– DOM å…ƒç´ 
            const loginPage = document.getElementById('loginPage');
            const mainPage = document.getElementById('mainPage');
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const currentUserSpan = document.getElementById('currentUser');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            console.log('DOM å…ƒç´ ç²å–çµæœ:', {
                loginPage: !!loginPage,
                mainPage: !!mainPage,
                loginForm: !!loginForm,
                logoutBtn: !!logoutBtn,
                currentUserSpan: !!currentUserSpan
            });
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            checkLoginStatus();
            
            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // æ¨™ç±¤é åˆ‡æ›
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
            
            // é‡æ–°æ•´ç†æŒ‰éˆ•
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', loadInitialData);
            }
            
            const refreshBackupsBtn = document.getElementById('refreshBackupsBtn');
            if (refreshBackupsBtn) {
                refreshBackupsBtn.addEventListener('click', loadBackupsList);
            }

            // å…¨é¸/å–æ¶ˆå…¨é¸æŒ‰éˆ•
            const selectAllWorkflowsBtn = document.getElementById('selectAllWorkflows');
            const deselectAllWorkflowsBtn = document.getElementById('deselectAllWorkflows');
            const selectAllCredentialsBtn = document.getElementById('selectAllCredentials');
            const deselectAllCredentialsBtn = document.getElementById('deselectAllCredentials');

            if (selectAllWorkflowsBtn) {
                selectAllWorkflowsBtn.addEventListener('click', () => selectAllWorkflows(true));
            }
            if (deselectAllWorkflowsBtn) {
                deselectAllWorkflowsBtn.addEventListener('click', () => selectAllWorkflows(false));
            }
            if (selectAllCredentialsBtn) {
                selectAllCredentialsBtn.addEventListener('click', () => selectAllCredentials(true));
            }
            if (deselectAllCredentialsBtn) {
                deselectAllCredentialsBtn.addEventListener('click', () => selectAllCredentials(false));
            }

            // æ™ºèƒ½é—œè¯é–‹é—œäº‹ä»¶
            const smartToggle = document.getElementById('smartSelectionToggle');
            if (smartToggle) {
                smartToggle.addEventListener('change', handleSmartToggleChange);
            }

            // å‚™ä»½ç›¸é—œäº‹ä»¶
            const startBackupBtn = document.getElementById('startBackupBtn');
            if (startBackupBtn) {
                startBackupBtn.addEventListener('click', handleBackup);
            }

            // é‚„åŸç›¸é—œäº‹ä»¶
            const restoreSource = document.getElementById('restoreSource');
            if (restoreSource) {
                restoreSource.addEventListener('change', loadBackupsList);
            }
            
            const startRestoreBtn = document.getElementById('startRestoreBtn');
            if (startRestoreBtn) {
                startRestoreBtn.addEventListener('click', handleRestore);
            }

            // æ•æ„Ÿæ†‘è­‰æ¨¡å¼è®ŠåŒ–
            document.addEventListener('change', function(e) {
                if (e.target.name === 'sensitiveCredentialMode') {
                    handleSensitiveCredentialModeChange();
                }
            });
            
            // éµç›¤å¿«æ·éµ
            document.addEventListener('keydown', handleKeyboardShortcuts);
        });
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkLoginStatus() {
            console.log('æª¢æŸ¥ç™»å…¥ç‹€æ…‹...');
            
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken && savedUser) {
                console.log('æ‰¾åˆ°ä¿å­˜çš„ç™»å…¥ä¿¡æ¯');
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                showMainPage();
                loadInitialData();
            } else {
                console.log('æ²’æœ‰æ‰¾åˆ°ç™»å…¥ä¿¡æ¯ï¼Œé¡¯ç¤ºç™»å…¥é é¢');
                showLoginPage();
            }
        }
        
        // é¡¯ç¤ºç™»å…¥é é¢
        function showLoginPage() {
            console.log('é¡¯ç¤ºç™»å…¥é é¢');
            const loginPage = document.getElementById('loginPage');
            const mainPage = document.getElementById('mainPage');
            
            if (loginPage) loginPage.classList.remove('hidden');
            if (mainPage) mainPage.classList.add('hidden');
        }
        
        // é¡¯ç¤ºä¸»é é¢
        function showMainPage() {
            console.log('é¡¯ç¤ºä¸»é é¢');
            const loginPage = document.getElementById('loginPage');
            const mainPage = document.getElementById('mainPage');
            const currentUserSpan = document.getElementById('currentUser');
            
            if (loginPage) loginPage.classList.add('hidden');
            if (mainPage) mainPage.classList.remove('hidden');
            if (currentUserSpan && currentUser) {
                currentUserSpan.textContent = currentUser.username;
            }
        }
        
        // è™•ç†ç™»å…¥
        async function handleLogin(e) {
            e.preventDefault();
            console.log('è™•ç†ç™»å…¥...');
            
            const formData = new FormData(e.target);
            const loginData = {
                username: formData.get('username'),
                password: formData.get('password')
            };
            
            try {
                showLoading('ç™»å…¥ä¸­...');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    authToken = result.token;
                    currentUser = result.user;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showMainPage();
                    loadInitialData();
                    showNotification('ç™»å…¥æˆåŠŸ', 'success');
                } else {
                    showNotification(result.error || 'ç™»å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // è™•ç†ç™»å‡º
        function handleLogout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showLoginPage();
            showNotification('å·²ç™»å‡º', 'info');
        }
        
        // è¼‰å…¥åˆå§‹æ•¸æ“š
        async function loadInitialData() {
            if (!authToken) return;
            
            try {
                showLoading('è¼‰å…¥æ•¸æ“šä¸­...');
                
                const [workflowsResponse, credentialsResponse] = await Promise.all([
                    fetch('/api/n8n/workflows', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch('/api/n8n/credentials', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                workflows = await workflowsResponse.json();
                credentials = await credentialsResponse.json();
                
                renderWorkflowsList();
                renderCredentialsList();
                
                showNotification('æ•¸æ“šè¼‰å…¥å®Œæˆ', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('è¼‰å…¥æ•¸æ“šå¤±æ•—', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // æ¸²æŸ“ workflows åˆ—è¡¨
        function renderWorkflowsList() {
            const container = document.getElementById('workflowsList');
            const countElement = document.getElementById('workflowCount');
            
            if (!container || !countElement) return;
            
            countElement.textContent = workflows.length;
            
            if (workflows.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æ²’æœ‰æ‰¾åˆ° workflows</div>';
                return;
            }
            
            container.innerHTML = workflows.map(workflow => {
                const relatedCredentialIds = workflow.relatedCredentialIds || [];
                const relatedCount = relatedCredentialIds.length;
                
                // ç²å–ç›¸é—œæ†‘è­‰çš„åç¨±ç”¨æ–¼æç¤º
                const relatedCredentialNames = relatedCredentialIds
                    .map(id => {
                        const credential = credentials.find(c => c.id === id);
                        return credential ? credential.name : `ID: ${id}`;
                    })
                    .join(', ');
                
                const tooltipText = relatedCount > 0 
                    ? `é¸ä¸­æ­¤ workflow å°‡è‡ªå‹•é¸ä¸­ä»¥ä¸‹æ†‘è­‰ï¼š\n${relatedCredentialNames}`
                    : 'æ­¤ workflow ä¸ä½¿ç”¨ä»»ä½•æ†‘è­‰';
                
                return `
                    <div class="item-checkbox workflow-item" id="workflow-item-${workflow.id}"
                         onmouseenter="highlightRelatedCredentials('${workflow.id}', true)"
                         onmouseleave="highlightRelatedCredentials('${workflow.id}', false)">
                        <input type="checkbox" id="workflow-${workflow.id}" value="${workflow.id}" data-type="workflow"
                               data-related-credentials="${relatedCredentialIds.join(',')}"
                               onchange="handleWorkflowSelection(this)">
                        <div class="item-info">
                            <div class="item-name">
                                ${workflow.name}
                                ${relatedCount > 0 ? `<span class="related-indicator" title="${tooltipText}">ğŸ”—${relatedCount}</span>` : ''}
                            </div>
                            <div class="item-details">
                                <span class="item-status ${workflow.active ? 'status-active' : 'status-inactive'}">
                                    <i class="fas ${workflow.active ? 'fa-play' : 'fa-pause'}"></i>
                                    ${workflow.active ? 'å•Ÿç”¨' : 'åœç”¨'}
                                </span>
                                ${workflow.tags ? workflow.tags.map(tag => `<span class="item-tag">${tag}</span>`).join('') : ''}
                                <span class="related-credentials-info">ç›¸é—œæ†‘è­‰: ${relatedCount}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // åˆå§‹åŒ–å¾Œæ›´æ–°è¨ˆæ•¸
            updateSelectionCounts();
        }
        
        // æ¸²æŸ“ credentials åˆ—è¡¨
        function renderCredentialsList() {
            const container = document.getElementById('credentialsList');
            const countElement = document.getElementById('credentialCount');
            
            if (!container || !countElement) return;
            
            countElement.textContent = credentials.length;
            
            if (credentials.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æ²’æœ‰æ‰¾åˆ° credentials</div>';
                return;
            }
            
            container.innerHTML = credentials.map(credential => `
                <div class="item-checkbox" id="credential-item-${credential.id}">
                    <input type="checkbox" id="credential-${credential.id}" value="${credential.id}" data-type="credential">
                    <div class="item-info">
                        <div class="item-name">${credential.name}</div>
                        <div class="item-details">
                            <span>é¡å‹: ${credential.type}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ™ºèƒ½é—œè¯ï¼šå‹¾é¸ workflow æ™‚è‡ªå‹•å‹¾é¸å…¶æ‰€ç”¨ credentials
        function handleWorkflowSelection(workflowCheckbox) {
            const isChecked = workflowCheckbox.checked;
            const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
            
            // æª¢æŸ¥æ™ºèƒ½é—œè¯é–‹é—œæ˜¯å¦å•Ÿç”¨
            const smartToggle = document.getElementById('smartSelectionToggle');
            const smartSelectionEnabled = smartToggle ? smartToggle.checked : true;
            
            if (!relatedCredentialIds || !smartSelectionEnabled) {
                updateSelectionCounts();
                return;
            }

            const credentialIds = relatedCredentialIds.split(',').filter(id => id.trim());
            
            credentialIds.forEach(credentialId => {
                const credentialCheckbox = document.getElementById(`credential-${credentialId}`);
                const credentialItem = document.getElementById(`credential-item-${credentialId}`);
                
                if (!credentialCheckbox) return;

                if (isChecked) {
                    // å‹¾é¸ workflow æ™‚ï¼Œè‡ªå‹•å‹¾é¸ç›¸é—œçš„ credentials
                    credentialCheckbox.checked = true;
                    if (credentialItem) {
                        credentialItem.classList.add('auto-selected');
                        // æ·»åŠ è¦–è¦ºæç¤ºå‹•ç•«
                        credentialItem.style.animation = 'highlightAutoSelect 0.5s ease';
                        setTimeout(() => {
                            credentialItem.style.animation = '';
                        }, 500);
                    }
                } else {
                    // å–æ¶ˆå‹¾é¸ workflow æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»– workflow ä½¿ç”¨é€™å€‹ credential
                    const stillNeeded = isCredentialStillNeeded(credentialId);
                    if (!stillNeeded) {
                        credentialCheckbox.checked = false;
                        if (credentialItem) {
                            credentialItem.classList.remove('auto-selected');
                            // æ·»åŠ å–æ¶ˆé¸ä¸­çš„å‹•ç•«
                            credentialItem.style.animation = 'highlightAutoDeselect 0.5s ease';
                            setTimeout(() => {
                                credentialItem.style.animation = '';
                            }, 500);
                        }
                    }
                }
            });
            
            // é¡¯ç¤ºæç¤ºä¿¡æ¯ï¼ˆåªåœ¨æœ‰å¯¦éš›æ“ä½œæ™‚é¡¯ç¤ºï¼‰
            if (credentialIds.length > 0) {
                const action = isChecked ? 'é¸ä¸­' : 'å–æ¶ˆé¸ä¸­';
                showSmartSelectionNotification(`å·²è‡ªå‹•${action}ç›¸é—œæ†‘è­‰`, 'info');
            }
            
            // æ›´æ–°é¸ä¸­è¨ˆæ•¸
            updateSelectionCounts();
        }

        // åˆ¤æ–·æŸ credential æ˜¯å¦ä»è¢«å…¶ä»–å·²é¸ workflow éœ€è¦
        function isCredentialStillNeeded(credentialId) {
            const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked');
            for (const wf of selectedWorkflows) {
                const ids = (wf.dataset.relatedCredentials || '').split(',');
                if (ids.includes(credentialId)) return true;
            }
            return false;
        }

        // æ›´æ–°é¸ä¸­é …ç›®è¨ˆæ•¸
        function updateSelectionCounts() {
            const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked').length;
            const selectedCredentials = document.querySelectorAll('input[data-type="credential"]:checked').length;
            const autoSelectedCredentials = document.querySelectorAll('.item-checkbox.auto-selected input:checked').length;
            
            // æ›´æ–°æ‘˜è¦é¢æ¿
            const summaryPanel = document.getElementById('selectionSummary');
            const selectedWorkflowsCountEl = document.getElementById('selectedWorkflowsCount');
            const selectedCredentialsCountEl = document.getElementById('selectedCredentialsCount');
            const autoSelectedCountEl = document.getElementById('autoSelectedCount');
            const totalSelectedCountEl = document.getElementById('totalSelectedCount');
            
            if (summaryPanel && selectedWorkflowsCountEl && selectedCredentialsCountEl && autoSelectedCountEl && totalSelectedCountEl) {
                const totalSelected = selectedWorkflows + selectedCredentials;
                
                if (totalSelected > 0) {
                    summaryPanel.style.display = 'block';
                    selectedWorkflowsCountEl.textContent = selectedWorkflows;
                    selectedCredentialsCountEl.textContent = selectedCredentials;
                    autoSelectedCountEl.textContent = `(${autoSelectedCredentials} å€‹è‡ªå‹•é¸ä¸­)`;
                    totalSelectedCountEl.textContent = totalSelected;
                } else {
                    summaryPanel.style.display = 'none';
                }
            }
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºé¸ä¸­æ•¸é‡
            const backupBtn = document.getElementById('startBackupBtn');
            if (backupBtn) {
                const totalSelected = selectedWorkflows + selectedCredentials;
                if (totalSelected > 0) {
                    backupBtn.innerHTML = `<i class="fas fa-upload"></i> é–‹å§‹å‚™ä»½ (${selectedWorkflows} å€‹ Workflows, ${selectedCredentials} å€‹ Credentials)`;
                    backupBtn.disabled = false;
                    backupBtn.classList.add('ready');
                } else {
                    backupBtn.innerHTML = `<i class="fas fa-upload"></i> é–‹å§‹å‚™ä»½`;
                    backupBtn.disabled = true;
                    backupBtn.classList.remove('ready');
                }
            }
        }

        // é¡¯ç¤ºæ™ºèƒ½é¸æ“‡é€šçŸ¥ï¼ˆä¸å¹²æ“¾ç”¨æˆ¶çš„è¼•é‡æç¤ºï¼‰
        function showSmartSelectionNotification(message, type = 'info') {
            // å‰µå»ºä¸€å€‹è¼•é‡ç´šçš„æç¤ºï¼Œä¸æœƒåƒæ™®é€šé€šçŸ¥é‚£æ¨£æŒçºŒé¡¯ç¤º
            const notification = document.createElement('div');
            notification.className = `smart-notification ${type}`;
            notification.textContent = message;
            
            const container = document.getElementById('notifications');
            if (container) {
                container.appendChild(notification);
                
                // æ›´çŸ­çš„é¡¯ç¤ºæ™‚é–“ï¼Œä¸å¹²æ“¾ç”¨æˆ¶
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        notification.remove();
                    }, 200);
                }, 1500);
            }
        }

        // é«˜äº®ç›¸é—œæ†‘è­‰
        function highlightRelatedCredentials(workflowId, highlight) {
            const workflowCheckbox = document.getElementById(`workflow-${workflowId}`);
            if (!workflowCheckbox) return;
            
            const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
            if (!relatedCredentialIds) return;
            
            const credentialIds = relatedCredentialIds.split(',').filter(id => id.trim());
            
            credentialIds.forEach(credentialId => {
                const credentialItem = document.getElementById(`credential-item-${credentialId}`);
                if (credentialItem) {
                    if (highlight) {
                        credentialItem.classList.add('related-highlight');
                    } else {
                        credentialItem.classList.remove('related-highlight');
                    }
                }
            });
        }

        // å…¨é¸/å–æ¶ˆå…¨é¸åŠŸèƒ½å¢å¼·
        function selectAllWorkflows(select) {
            const checkboxes = document.querySelectorAll('input[data-type="workflow"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
                handleWorkflowSelection(checkbox);
            });
        }

        function selectAllCredentials(select) {
            const checkboxes = document.querySelectorAll('input[data-type="credential"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
                // ç§»é™¤è‡ªå‹•é¸ä¸­æ¨™è¨˜ï¼Œå› ç‚ºé€™æ˜¯æ‰‹å‹•å…¨é¸
                const credentialItem = document.getElementById(`credential-item-${checkbox.value}`);
                if (credentialItem && !select) {
                    credentialItem.classList.remove('auto-selected');
                }
            });
            updateSelectionCounts();
        }

        // è™•ç†æ™ºèƒ½é—œè¯é–‹é—œè®ŠåŒ–
        function handleSmartToggleChange() {
            const smartToggle = document.getElementById('smartSelectionToggle');
            const isEnabled = smartToggle.checked;
            
            if (!isEnabled) {
                // é—œé–‰æ™ºèƒ½é—œè¯æ™‚ï¼Œæ¸…é™¤æ‰€æœ‰è‡ªå‹•é¸ä¸­æ¨™è¨˜
                document.querySelectorAll('.item-checkbox.auto-selected').forEach(item => {
                    item.classList.remove('auto-selected');
                });
                showSmartSelectionNotification('æ™ºèƒ½é—œè¯å·²é—œé–‰', 'info');
            } else {
                // é–‹å•Ÿæ™ºèƒ½é—œè¯æ™‚ï¼Œé‡æ–°æ‡‰ç”¨æ™ºèƒ½é¸æ“‡
                const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked');
                selectedWorkflows.forEach(workflowCheckbox => {
                    handleWorkflowSelection(workflowCheckbox);
                });
                showSmartSelectionNotification('æ™ºèƒ½é—œè¯å·²é–‹å•Ÿ', 'info');
            }
            
            updateSelectionCounts();
        }

        // éµç›¤å¿«æ·éµè™•ç†
        function handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + S: åˆ‡æ›æ™ºèƒ½é—œè¯
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const smartToggle = document.getElementById('smartSelectionToggle');
                if (smartToggle) {
                    smartToggle.checked = !smartToggle.checked;
                    handleSmartToggleChange();
                }
            }
            
            // Ctrl/Cmd + A: å…¨é¸ workflows
            if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.shiftKey) {
                e.preventDefault();
                selectAllWorkflows(true);
            }
            
            // Ctrl/Cmd + D: å–æ¶ˆå…¨é¸
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                selectAllWorkflows(false);
                selectAllCredentials(false);
            }
        }
        
        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(tabName) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // æ ¹æ“šæ¨™ç±¤é è¼‰å…¥ç›¸æ‡‰æ•¸æ“š
            if (tabName === 'restore') {
                loadBackupsList();
            }
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        function showLoading(text = 'è¼‰å…¥ä¸­...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (loadingText) loadingText.textContent = text;
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }
        
        // éš±è—è¼‰å…¥ä¸­
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }
        
        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            const container = document.getElementById('notifications');
            if (container) {
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // è¼‰å…¥å‚™ä»½åˆ—è¡¨
        async function loadBackupsList() {
            if (!authToken) return;
            
            const source = document.getElementById('restoreSource').value;
            const container = document.getElementById('availableBackups');
            
            try {
                showLoading('è¼‰å…¥å‚™ä»½åˆ—è¡¨...');
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">è¼‰å…¥ä¸­...</div>';
                
                const response = await fetch(`/api/restore/${source}/list`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const backups = await response.json();
                renderBackupsList(backups, source);
                
            } catch (error) {
                console.error('Error loading backups:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #f44336;">è¼‰å…¥å‚™ä»½åˆ—è¡¨å¤±æ•—</div>';
                showNotification('è¼‰å…¥å‚™ä»½åˆ—è¡¨å¤±æ•—', 'error');
            } finally {
                hideLoading();
            }
        }

        // æ¸²æŸ“å‚™ä»½åˆ—è¡¨
        function renderBackupsList(backups, source) {
            const container = document.getElementById('availableBackups');
            
            if (backups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æ²’æœ‰æ‰¾åˆ°å‚™ä»½æ–‡ä»¶</div>';
                return;
            }
            
            container.innerHTML = backups.map(backup => `
                <div class="backup-item" data-backup-id="${backup.id || backup.name}" data-source="${source}">
                    <div class="backup-info">
                        <div class="backup-name">${backup.name}</div>
                        <div class="backup-meta">
                            <span><i class="fas fa-calendar"></i> ${formatDate(backup.createdAt || backup.createdTime)}</span>
                            <span><i class="fas fa-hdd"></i> ${formatFileSize(backup.size)}</span>
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-sm btn-outline" onclick="previewBackup('${backup.id || backup.name}', '${source}')">
                            <i class="fas fa-eye"></i> é è¦½
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="selectBackup('${backup.id || backup.name}', '${source}')">
                            <i class="fas fa-check"></i> é¸æ“‡
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // é è¦½å‚™ä»½
        async function previewBackup(backupId, source) {
            try {
                showLoading('è¼‰å…¥å‚™ä»½é è¦½...');
                
                const response = await fetch(`/api/restore/${source}/preview/${backupId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const preview = await response.json();
                
                const message = `
å‚™ä»½æ™‚é–“: ${formatDate(preview.timestamp)}
Workflows: ${preview.workflows.length} å€‹
Credentials: ${preview.credentials.length} å€‹

Workflows:
${preview.workflows.map(w => `- ${w.name} (${w.active ? 'å•Ÿç”¨' : 'åœç”¨'})`).join('\n')}

Credentials:
${preview.credentials.map(c => `- ${c.name} (${c.type})`).join('\n')}
                `;
                
                alert(message);
                
            } catch (error) {
                console.error('Error previewing backup:', error);
                showNotification('è¼‰å…¥é è¦½å¤±æ•—', 'error');
            } finally {
                hideLoading();
            }
        }

        // é¸æ“‡å‚™ä»½
        async function selectBackup(backupId, source) {
            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.backup-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-backup-id="${backupId}"]`).classList.add('selected');
            
            selectedBackup = { id: backupId, source };
            
            // è¼‰å…¥å‚™ä»½å…§å®¹ç”¨æ–¼é¸æ“‡é‚„åŸé …ç›®
            try {
                showLoading('è¼‰å…¥å‚™ä»½å…§å®¹...');
                
                const response = await fetch(`/api/restore/${source}/preview/${backupId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const preview = await response.json();
                renderRestoreItemsSelection(preview);
                
                document.getElementById('restoreOptions').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading backup content:', error);
                showNotification('è¼‰å…¥å‚™ä»½å…§å®¹å¤±æ•—', 'error');
            } finally {
                hideLoading();
            }
        }

        // æ¸²æŸ“é‚„åŸé …ç›®é¸æ“‡
        function renderRestoreItemsSelection(preview) {
            const container = document.getElementById('restoreItemsSelection');
            
            // æª¢æ¸¬æ•æ„Ÿæ†‘è­‰
            const sensitiveTypes = ['googleSheetsOAuth2Api', 'googleDriveOAuth2Api', 'gmailOAuth2', 'slackOAuth2Api'];
            const sensitiveCredentials = preview.credentials.filter(cred => 
                sensitiveTypes.includes(cred.type)
            );
            const hasSensitiveCredentials = sensitiveCredentials.length > 0;
            
            container.innerHTML = `
                <div class="items-selection">
                    <div class="selection-section">
                        <div class="section-header">
                            <h3>
                                <i class="fas fa-project-diagram"></i>
                                Workflows
                                <span class="item-count">${preview.workflows.length}</span>
                            </h3>
                            <div class="selection-controls">
                                <button class="btn btn-sm" onclick="selectAllRestoreItems('workflows', true)">å…¨é¸</button>
                                <button class="btn btn-sm" onclick="selectAllRestoreItems('workflows', false)">å–æ¶ˆå…¨é¸</button>
                            </div>
                        </div>
                        <div class="items-list">
                            ${preview.workflows.map(workflow => `
                                <div class="item-checkbox">
                                    <input type="checkbox" id="restore-workflow-${workflow.id}" value="${workflow.id}" data-type="restore-workflow" checked>
                                    <div class="item-info">
                                        <div class="item-name">${workflow.name}</div>
                                        <div class="item-details">
                                            <span class="item-status ${workflow.active ? 'status-active' : 'status-inactive'}">
                                                <i class="fas ${workflow.active ? 'fa-play' : 'fa-pause'}"></i>
                                                ${workflow.active ? 'å•Ÿç”¨' : 'åœç”¨'}
                                            </span>
                                            ${workflow.tags ? workflow.tags.map(tag => `<span class="item-tag">${tag}</span>`).join('') : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="selection-section">
                        <div class="section-header">
                            <h3>
                                <i class="fas fa-key"></i>
                                Credentials
                                <span class="item-count">${preview.credentials.length}</span>
                                ${hasSensitiveCredentials ? '<span class="sensitive-badge">âš ï¸ åŒ…å«æ•æ„Ÿæ†‘è­‰</span>' : ''}
                            </h3>
                            <div class="selection-controls">
                                <button class="btn btn-sm" onclick="selectAllRestoreItems('credentials', true)">å…¨é¸</button>
                                <button class="btn btn-sm" onclick="selectAllRestoreItems('credentials', false)">å–æ¶ˆå…¨é¸</button>
                            </div>
                        </div>
                        <div class="items-list">
                            ${preview.credentials.map(credential => {
                                const isSensitive = sensitiveTypes.includes(credential.type);
                                return `
                                    <div class="item-checkbox ${isSensitive ? 'sensitive-credential' : ''}">
                                        <input type="checkbox" id="restore-credential-${credential.id}" value="${credential.id}" data-type="restore-credential" checked>
                                        <div class="item-info">
                                            <div class="item-name">
                                                ${credential.name}
                                                ${isSensitive ? '<i class="fas fa-shield-alt sensitive-icon" title="æ•æ„Ÿæ†‘è­‰"></i>' : ''}
                                            </div>
                                            <div class="item-details">
                                                <span>é¡å‹: ${credential.type}</span>
                                                ${isSensitive ? '<span class="sensitive-warning">éœ€è¦ç‰¹æ®Šè™•ç†</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // å¦‚æœæœ‰æ•æ„Ÿæ†‘è­‰ï¼Œé¡¯ç¤ºè™•ç†é¸é …
            if (hasSensitiveCredentials) {
                document.getElementById('sensitiveCredentialsOptions').style.display = 'block';
                
                // é å¡«å……æ•æ„Ÿæ†‘è­‰æ˜ å°„
                sensitiveCredentials.forEach(cred => {
                    addCredentialMapping();
                    const lastMapping = document.querySelector('.credential-mapping-item:last-child');
                    if (lastMapping) {
                        lastMapping.querySelector('.source-credential').value = cred.id;
                        lastMapping.querySelector('.source-credential').placeholder = `${cred.name} (${cred.type})`;
                    }
                });
            }
            
            // å•Ÿç”¨é‚„åŸæŒ‰éˆ•
            document.getElementById('startRestoreBtn').disabled = false;
        }

        // å…¨é¸/å–æ¶ˆå…¨é¸é‚„åŸé …ç›®
        function selectAllRestoreItems(type, select) {
            const checkboxes = document.querySelectorAll(`input[data-type="restore-${type === 'workflows' ? 'workflow' : 'credential'}"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
            });
        }

        // è™•ç†é‚„åŸ
        async function handleRestore() {
            if (!selectedBackup) {
                showNotification('è«‹å…ˆé¸æ“‡è¦é‚„åŸçš„å‚™ä»½', 'warning');
                return;
            }
            
            const restoreMode = document.getElementById('restoreMode').value;
            const targetEnv = document.getElementById('restoreTarget').value;
            
            // ç²å–é¸ä¸­çš„é …ç›®
            const selectedWorkflows = Array.from(document.querySelectorAll('input[data-type="restore-workflow"]:checked'))
                .map(cb => cb.value);
            const selectedCredentials = Array.from(document.querySelectorAll('input[data-type="restore-credential"]:checked'))
                .map(cb => cb.value);
            
            if (selectedWorkflows.length === 0 && selectedCredentials.length === 0) {
                showNotification('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é …ç›®é€²è¡Œé‚„åŸ', 'warning');
                return;
            }
            
            // ç²å–æ•æ„Ÿæ†‘è­‰è™•ç†æ¨¡å¼
            const sensitiveMode = document.querySelector('input[name="sensitiveCredentialMode"]:checked')?.value || 'skip';
            
            // ç²å–æ†‘è­‰æ˜ å°„
            const credentialMapping = {};
            if (sensitiveMode === 'map') {
                document.querySelectorAll('.credential-mapping-item').forEach(item => {
                    const source = item.querySelector('.source-credential')?.value;
                    const target = item.querySelector('.target-credential')?.value;
                    if (source && target) {
                        credentialMapping[source] = target;
                    }
                });
            }
            
            try {
                showLoading('æ­£åœ¨é‚„åŸ...');
                
                const restoreData = {
                    [selectedBackup.source === 'github' ? 'fileName' : 'fileId']: selectedBackup.id,
                    selectedItems: {
                        workflows: selectedWorkflows,
                        credentials: selectedCredentials
                    },
                    restoreMode: sensitiveMode === 'force' ? 'force_all' : restoreMode,
                    targetEnvironment: targetEnv,
                    credentialMapping: credentialMapping
                };
                
                const response = await fetch(`/api/restore/${selectedBackup.source}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(restoreData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('é‚„åŸå®Œæˆ', 'success');
                    
                    // é¡¯ç¤ºè©³ç´°çµæœ
                    showRestoreResults(result.result);
                    
                    // é‡æ–°è¼‰å…¥æ•¸æ“š
                    loadInitialData();
                } else {
                    showNotification(result.error || 'é‚„åŸå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('Restore error:', error);
                showNotification('é‚„åŸå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // æ·»åŠ æ†‘è­‰æ˜ å°„é …ç›®
        function addCredentialMapping() {
            const container = document.getElementById('credentialMappingList');
            const mappingDiv = document.createElement('div');
            mappingDiv.className = 'credential-mapping-item';
            mappingDiv.innerHTML = `
                <div class="mapping-row">
                    <input type="text" class="source-credential" placeholder="å‚™ä»½æ†‘è­‰ ID">
                    <span class="mapping-arrow">â†’</span>
                    <input type="text" class="target-credential" placeholder="ç›®æ¨™æ†‘è­‰ ID">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeCredentialMapping(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(mappingDiv);
        }
        
        // ç§»é™¤æ†‘è­‰æ˜ å°„é …ç›®
        function removeCredentialMapping(button) {
            button.closest('.credential-mapping-item').remove();
        }
        
        // è™•ç†æ•æ„Ÿæ†‘è­‰æ¨¡å¼è®ŠåŒ–
        function handleSensitiveCredentialModeChange() {
            const mode = document.querySelector('input[name="sensitiveCredentialMode"]:checked')?.value;
            const mappingSection = document.getElementById('credentialMappingSection');
            const forceWarning = document.getElementById('forceRestoreWarning');
            
            // é¡¯ç¤º/éš±è—ç›¸æ‡‰çš„é¸é …
            if (mode === 'map') {
                mappingSection.style.display = 'block';
                forceWarning.style.display = 'none';
            } else if (mode === 'force') {
                mappingSection.style.display = 'none';
                forceWarning.style.display = 'block';
            } else {
                mappingSection.style.display = 'none';
                forceWarning.style.display = 'none';
            }
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW');
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (!bytes) return 'æœªçŸ¥';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // æ·»åŠ å‚™ä»½é€²åº¦æŒ‡ç¤º
        function showBackupProgress(message) {
            const existingProgress = document.querySelector('.backup-progress');
            if (existingProgress) {
                existingProgress.remove();
            }
            
            const progress = document.createElement('div');
            progress.className = 'backup-progress';
            progress.innerHTML = `
                <div class="progress-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>${message}</span>
                </div>
            `;
            
            const backupActions = document.querySelector('.backup-actions');
            if (backupActions) {
                backupActions.appendChild(progress);
            }
        }

        // è™•ç†å‚™ä»½æ–¹å¼è®ŠåŒ–
        function handleBackupMethodChange() {
            const method = document.getElementById('backupMethod').value;
            const warning = document.getElementById('credentialDataWarning');
            
            if (method === 'cli') {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }
        
        // è™•ç†å‚™ä»½
        async function handleBackup() {
            const backupName = document.getElementById('backupName').value;
            const destination = document.getElementById('backupDestination').value;
            const method = document.getElementById('backupMethod').value;
            
            // CLI å‚™ä»½æ–¹å¼
            if (method === 'cli') {
                const includeCredentials = document.getElementById('includeCredentialData').checked;
                
                if (includeCredentials && !confirm('âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°‡å‰µå»ºåŒ…å«æ•æ„Ÿæ†‘è­‰æ•¸æ“šçš„å‚™ä»½ã€‚é€™å¯èƒ½å¸¶ä¾†å®‰å…¨é¢¨éšªã€‚\n\nè«‹ç¢ºä¿ï¼š\n1. å‚™ä»½æ–‡ä»¶å°‡å­˜å„²åœ¨å®‰å…¨ä½ç½®\n2. æ‚¨äº†è§£ç›¸é—œçš„å®‰å…¨é¢¨éšª\n3. æ‚¨æœ‰æ¬Šé™è¨ªå•é€™äº›æ•æ„Ÿæ•¸æ“š\n\næ˜¯å¦ç¹¼çºŒï¼Ÿ')) {
                    return;
                }
                
                try {
                    showLoading('æ­£åœ¨ä½¿ç”¨ CLI é€²è¡Œå‚™ä»½...');
                    showBackupProgress('åŸ·è¡Œ N8N CLI å°å‡º...');
                    
                    const response = await fetch('/api/backup/cli-export', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            backupName: backupName || `cli-backup-${new Date().toISOString().split('T')[0]}`,
                            destination,
                            includeCredentials
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification(`CLI å‚™ä»½æˆåŠŸï¼å·²å‚™ä»½ ${result.workflowCount} å€‹å·¥ä½œæµ`, 'success');
                        
                        // é¡¯ç¤ºå‚™ä»½æˆåŠŸä¿¡æ¯
                        showBackupSuccess(result, result.fileName, destination, result.workflowCount, 0);
                        
                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById('backupName').value = '';
                        document.getElementById('includeCredentialData').checked = false;
                    } else {
                        showNotification(result.error || 'CLI å‚™ä»½å¤±æ•—', 'error');
                    }
                } catch (error) {
                    console.error('CLI Backup error:', error);
                    showNotification('CLI å‚™ä»½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ N8N CLI æ˜¯å¦æ­£ç¢ºå®‰è£', 'error');
                } finally {
                    hideLoading();
                    const progress = document.querySelector('.backup-progress');
                    if (progress) progress.remove();
                }
                return;
            }
            
            // API å‚™ä»½æ–¹å¼ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
            const selectedWorkflows = Array.from(document.querySelectorAll('input[data-type="workflow"]:checked'))
                .map(cb => cb.value);
            const selectedCredentials = Array.from(document.querySelectorAll('input[data-type="credential"]:checked'))
                .map(cb => cb.value);
            
            if (selectedWorkflows.length === 0 && selectedCredentials.length === 0) {
                showSmartBackupSuggestion();
                return;
            }
            
            try {
                showLoading('æ­£åœ¨å‚™ä»½...');
                showBackupProgress('æº–å‚™å‚™ä»½æ•¸æ“š...');
                
                const finalBackupName = backupName || `backup-${new Date().toISOString().split('T')[0]}`;
                
                const backupData = {
                    workflows,
                    credentials,
                    selectedItems: {
                        workflows: selectedWorkflows,
                        credentials: selectedCredentials
                    },
                    backupName: finalBackupName,
                    sourceEnvironment: 'default'
                };
                
                showBackupProgress(`ä¸Šå‚³åˆ° ${destination.toUpperCase()}...`);
                
                const response = await fetch(`/api/backup/${destination}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(backupData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`å‚™ä»½æˆåŠŸï¼æ–‡ä»¶å·²ä¸Šå‚³åˆ° ${destination.toUpperCase()}`, 'success');
                    
                    // é¡¯ç¤ºå‚™ä»½æˆåŠŸçš„è©³ç´°ä¿¡æ¯
                    showBackupSuccess(result, finalBackupName, destination, selectedWorkflows.length, selectedCredentials.length);
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('backupName').value = '';
                    selectAllWorkflows(false);
                    selectAllCredentials(false);
                } else {
                    showNotification(result.error || 'å‚™ä»½å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('Backup error:', error);
                showNotification('å‚™ä»½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥', 'error');
            } finally {
                hideLoading();
                // ç§»é™¤é€²åº¦æŒ‡ç¤º
                const progress = document.querySelector('.backup-progress');
                if (progress) {
                    progress.remove();
                }
            }
        }

        // é¡¯ç¤ºé‚„åŸçµæœ
        function showRestoreResults(results) {
            const modal = document.createElement('div');
            modal.className = 'restore-results-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeRestoreResults()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-check-circle"></i> é‚„åŸå®Œæˆ</h3>
                        <button class="modal-close" onclick="closeRestoreResults()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="results-summary">
                            <div class="result-section">
                                <h4><i class="fas fa-project-diagram"></i> Workflows</h4>
                                <div class="result-stats">
                                    <span class="success-count">æˆåŠŸ: ${results.workflows.success.length}</span>
                                    <span class="failed-count">å¤±æ•—: ${results.workflows.failed.length}</span>
                                </div>
                                ${results.workflows.success.length > 0 ? `
                                    <div class="success-items">
                                        <h5>æˆåŠŸé‚„åŸçš„ Workflows:</h5>
                                        <ul>
                                            ${results.workflows.success.map(w => `
                                                <li><i class="fas fa-check text-success"></i> ${w.name} (${w.action})</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${results.workflows.failed.length > 0 ? `
                                    <div class="failed-items">
                                        <h5>å¤±æ•—çš„ Workflows:</h5>
                                        <ul>
                                            ${results.workflows.failed.map(w => `
                                                <li><i class="fas fa-times text-error"></i> ${w.name}: ${w.error}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="result-section">
                                <h4><i class="fas fa-key"></i> Credentials</h4>
                                <div class="result-stats">
                                    <span class="success-count">æˆåŠŸ: ${results.credentials.success.length}</span>
                                    <span class="failed-count">å¤±æ•—: ${results.credentials.failed.length}</span>
                                </div>
                                ${results.credentials.success.length > 0 ? `
                                    <div class="success-items">
                                        <h5>æˆåŠŸé‚„åŸçš„ Credentials:</h5>
                                        <ul>
                                            ${results.credentials.success.map(c => `
                                                <li><i class="fas fa-check text-success"></i> ${c.name} (${c.action})</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${results.credentials.failed.length > 0 ? `
                                    <div class="failed-items">
                                        <h5>éœ€è¦æ‰‹å‹•é…ç½®çš„ Credentials:</h5>
                                        <ul>
                                            ${results.credentials.failed.map(c => `
                                                <li>
                                                    <i class="fas fa-exclamation-triangle text-warning"></i> 
                                                    ${c.name}: ${c.requiresManualSetup ? 'éœ€è¦æ‰‹å‹•é‡æ–°é…ç½®æ•æ„Ÿä¿¡æ¯' : c.error}
                                                </li>
                                            `).join('')}
                                        </ul>
                                        <div class="manual-setup-note">
                                            <i class="fas fa-info-circle"></i>
                                            <strong>æ³¨æ„:</strong> å‡ºæ–¼å®‰å…¨è€ƒæ…®ï¼ŒåŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ†‘è­‰ï¼ˆå¦‚ OAuth tokensï¼‰éœ€è¦æ‚¨æ‰‹å‹•é‡æ–°é…ç½®ã€‚
                                            è«‹å‰å¾€ N8N çš„ Credentials é é¢é‡æ–°è¨­ç½®é€™äº›æ†‘è­‰ã€‚
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="closeRestoreResults()">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // é—œé–‰é‚„åŸçµæœæ¨¡æ…‹æ¡†
        function closeRestoreResults() {
            const modal = document.querySelector('.restore-results-modal');
            if (modal) {
                modal.remove();
            }
        }

        // é¡¯ç¤ºå‚™ä»½æˆåŠŸä¿¡æ¯
        function showBackupSuccess(result, backupName, destination, workflowCount, credentialCount) {
            const modal = document.createElement('div');
            modal.className = 'backup-success-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeBackupSuccess()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-check-circle"></i> å‚™ä»½å®Œæˆ</h3>
                        <button class="modal-close" onclick="closeBackupSuccess()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="backup-success-info">
                            <div class="success-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="success-details">
                                <h4>å‚™ä»½å·²æˆåŠŸä¸Šå‚³åˆ° ${destination.toUpperCase()}</h4>
                                <div class="backup-stats">
                                    <div class="stat-item">
                                        <i class="fas fa-file-alt"></i>
                                        <span>å‚™ä»½åç¨±: ${backupName}</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-project-diagram"></i>
                                        <span>Workflows: ${workflowCount} å€‹</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-key"></i>
                                        <span>Credentials: ${credentialCount} å€‹</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-calendar"></i>
                                        <span>æ™‚é–“: ${new Date().toLocaleString('zh-TW')}</span>
                                    </div>
                                </div>
                                ${result.url ? `
                                    <div class="backup-link">
                                        <a href="${result.url}" target="_blank" class="btn btn-outline">
                                            <i class="fas fa-external-link-alt"></i>
                                            æŸ¥çœ‹å‚™ä»½æ–‡ä»¶
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="closeBackupSuccess()">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // é—œé–‰å‚™ä»½æˆåŠŸæ¨¡æ…‹æ¡†
        function closeBackupSuccess() {
            const modal = document.querySelector('.backup-success-modal');
            if (modal) {
                modal.remove();
            }
        }

        // æ™ºèƒ½å‚™ä»½å»ºè­°
        function showSmartBackupSuggestion() {
            const modal = document.createElement('div');
            modal.className = 'smart-suggestion-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeSmartSuggestion()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-lightbulb"></i> æ™ºèƒ½å‚™ä»½å»ºè­°</h3>
                        <button class="modal-close" onclick="closeSmartSuggestion()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="suggestion-content">
                            <p>æ‚¨é‚„æ²’æœ‰é¸æ“‡ä»»ä½•é …ç›®é€²è¡Œå‚™ä»½ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè­°ï¼š</p>
                            <div class="suggestions">
                                <div class="suggestion-item" onclick="selectActiveWorkflows()">
                                    <i class="fas fa-play-circle"></i>
                                    <div>
                                        <strong>å‚™ä»½æ‰€æœ‰å•Ÿç”¨çš„ Workflows</strong>
                                        <small>é¸æ“‡æ‰€æœ‰æ­£åœ¨é‹è¡Œçš„ workflows åŠå…¶ç›¸é—œæ†‘è­‰</small>
                                    </div>
                                </div>
                                <div class="suggestion-item" onclick="selectAllItems()">
                                    <i class="fas fa-globe"></i>
                                    <div>
                                        <strong>å®Œæ•´å‚™ä»½</strong>
                                        <small>å‚™ä»½æ‰€æœ‰ workflows å’Œ credentials</small>
                                    </div>
                                </div>
                                <div class="suggestion-item" onclick="selectRecentWorkflows()">
                                    <i class="fas fa-clock"></i>
                                    <div>
                                        <strong>å‚™ä»½æœ€è¿‘ä¿®æ”¹çš„é …ç›®</strong>
                                        <small>é¸æ“‡æœ€è¿‘æ›´æ–°çš„ workflows</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="closeSmartSuggestion()">æ‰‹å‹•é¸æ“‡</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // é—œé–‰æ™ºèƒ½å»ºè­°æ¨¡æ…‹æ¡†
        function closeSmartSuggestion() {
            const modal = document.querySelector('.smart-suggestion-modal');
            if (modal) {
                modal.remove();
            }
        }

        // é¸æ“‡å•Ÿç”¨çš„ workflows
        function selectActiveWorkflows() {
            const activeWorkflows = document.querySelectorAll('input[data-type="workflow"]');
            activeWorkflows.forEach(checkbox => {
                // é€™è£¡å¯ä»¥æ ¹æ“š workflow çš„ç‹€æ…‹ä¾†åˆ¤æ–·æ˜¯å¦å•Ÿç”¨
                // æš«æ™‚é¸æ“‡å‰å¹¾å€‹ä½œç‚ºç¤ºä¾‹
                checkbox.checked = true;
                handleWorkflowSelection(checkbox);
            });
            closeSmartSuggestion();
            showNotification('å·²é¸æ“‡å•Ÿç”¨çš„ workflows', 'info');
        }

        // é¸æ“‡æ‰€æœ‰é …ç›®
        function selectAllItems() {
            selectAllWorkflows(true);
            selectAllCredentials(true);
            closeSmartSuggestion();
            showNotification('å·²é¸æ“‡æ‰€æœ‰é …ç›®', 'info');
        }

        // é¸æ“‡æœ€è¿‘çš„ workflowsï¼ˆç¤ºä¾‹å¯¦ç¾ï¼‰
        function selectRecentWorkflows() {
            const workflowCheckboxes = document.querySelectorAll('input[data-type="workflow"]');
            // é¸æ“‡å‰5å€‹ä½œç‚º"æœ€è¿‘çš„"
            Array.from(workflowCheckboxes).slice(0, 5).forEach(checkbox => {
                checkbox.checked = true;
                handleWorkflowSelection(checkbox);
            });
            closeSmartSuggestion();
            showNotification('å·²é¸æ“‡æœ€è¿‘ä¿®æ”¹çš„ workflows', 'info');
        }

        // å…¨å±€è®Šé‡
        let selectedBackup = null;
    </script>
</body>
</html>