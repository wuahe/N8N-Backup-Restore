<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8N Backup & Restore Tool</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- 登入頁面 -->
        <div id="loginPage" class="page">
            <div class="login-container">
                <div class="login-form">
                    <h2><i class="fas fa-shield-alt"></i> N8N Backup & Restore</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="username">用戶名</label>
                            <input type="text" id="username" name="username" value="albouwu@gmail.com" required>
                        </div>
                        <div class="form-group">
                            <label for="password">密碼</label>
                            <input type="password" id="password" name="password" value="FI@600828" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> 登入
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 主頁面 -->
        <div id="mainPage" class="page hidden">
            <!-- 頂部導航 -->
            <nav class="navbar">
                <div class="nav-brand">
                    <i class="fas fa-database"></i>
                    N8N Backup & Restore
                </div>
                <div class="nav-actions">
                    <span class="user-info">
                        <i class="fas fa-user"></i>
                        <span id="currentUser">用戶</span>
                    </span>
                    <button id="logoutBtn" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i> 登出
                    </button>
                </div>
            </nav>

            <!-- 主要內容 -->
            <div class="main-content">
                <!-- 側邊欄 -->
                <aside class="sidebar">
                    <div class="sidebar-menu">
                        <button class="menu-item active" data-tab="backup">
                            <i class="fas fa-upload"></i>
                            <span>備份</span>
                        </button>
                        <button class="menu-item" data-tab="restore">
                            <i class="fas fa-download"></i>
                            <span>還原</span>
                        </button>
                        <button class="menu-item" data-tab="history">
                            <i class="fas fa-history"></i>
                            <span>備份歷史</span>
                        </button>
                        <button class="menu-item" data-tab="cross-env">
                            <i class="fas fa-exchange-alt"></i>
                            <span>跨環境</span>
                        </button>
                    </div>
                </aside>

                <!-- 內容區域 -->
                <main class="content">
                    <!-- 備份頁面 -->
                    <div id="backupTab" class="tab-content active">
                        <div class="content-header">
                            <h2><i class="fas fa-upload"></i> 備份 Workflows 和 Credentials</h2>
                            <button id="refreshDataBtn" class="btn btn-outline">
                                <i class="fas fa-sync-alt"></i> 重新整理
                            </button>
                        </div>

                        <div class="backup-container">
                            <div class="backup-settings">
                                <div class="form-group">
                                    <label for="backupName">備份名稱</label>
                                    <input type="text" id="backupName" placeholder="輸入備份名稱（可選）">
                                </div>
                                <div class="form-group">
                                    <label for="backupDestination">備份目標</label>
                                    <select id="backupDestination">
                                        <option value="github">GitHub</option>
                                        <option value="googledrive">Google Drive</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="smart-toggle-label">
                                        <input type="checkbox" id="smartSelectionToggle" checked>
                                        <span class="toggle-slider"></span>
                                        智能關聯選擇
                                    </label>
                                    <small class="form-help">
                                        自動選中 workflow 相關的憑證
                                        <br>
                                        <span class="keyboard-shortcuts">
                                            快捷鍵: Ctrl+S 切換 | Shift+Ctrl+A 全選 | Ctrl+D 清除
                                        </span>
                                    </small>
                                </div>
                            </div>

                            <div class="items-selection">
                                <div class="selection-section">
                                    <div class="section-header">
                                        <h3>
                                            <i class="fas fa-project-diagram"></i>
                                            Workflows
                                            <span class="item-count" id="workflowCount">0</span>
                                        </h3>
                                        <div class="selection-controls">
                                            <button class="btn btn-sm" id="selectAllWorkflows">全選</button>
                                            <button class="btn btn-sm" id="deselectAllWorkflows">取消全選</button>
                                        </div>
                                    </div>
                                    <div class="items-list" id="workflowsList">
                                        <div style="text-align: center; padding: 20px; color: #666;">
                                            載入中...
                                        </div>
                                    </div>
                                </div>

                                <div class="selection-section">
                                    <div class="section-header">
                                        <h3>
                                            <i class="fas fa-key"></i>
                                            Credentials
                                            <span class="item-count" id="credentialCount">0</span>
                                        </h3>
                                        <div class="selection-controls">
                                            <button class="btn btn-sm" id="selectAllCredentials">全選</button>
                                            <button class="btn btn-sm" id="deselectAllCredentials">取消全選</button>
                                        </div>
                                    </div>
                                    <div class="items-list" id="credentialsList">
                                        <div style="text-align: center; padding: 20px; color: #666;">
                                            載入中...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 智能選擇摘要 -->
                            <div class="selection-summary" id="selectionSummary" style="display: none;">
                                <div class="summary-header">
                                    <h4><i class="fas fa-magic"></i> 智能選擇摘要</h4>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-item">
                                        <span class="summary-label">已選 Workflows:</span>
                                        <span class="summary-value" id="selectedWorkflowsCount">0</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">已選 Credentials:</span>
                                        <span class="summary-value" id="selectedCredentialsCount">0</span>
                                        <span class="auto-selected-count" id="autoSelectedCount">(0 個自動選中)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">總計:</span>
                                        <span class="summary-value total" id="totalSelectedCount">0</span>
                                    </div>
                                </div>
                            </div>

                            <div class="backup-actions">
                                <button id="startBackupBtn" class="btn btn-primary btn-large" disabled>
                                    <i class="fas fa-upload"></i>
                                    開始備份
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 其他標籤頁內容 -->
                    <div id="restoreTab" class="tab-content">
                        <div class="content-header">
                            <h2><i class="fas fa-download"></i> 還原功能</h2>
                        </div>
                        <div style="text-align: center; padding: 40px;">
                            <p>還原功能正在開發中...</p>
                        </div>
                    </div>

                    <div id="historyTab" class="tab-content">
                        <div class="content-header">
                            <h2><i class="fas fa-history"></i> 備份歷史</h2>
                        </div>
                        <div style="text-align: center; padding: 40px;">
                            <p>歷史記錄功能正在開發中...</p>
                        </div>
                    </div>

                    <div id="cross-envTab" class="tab-content">
                        <div class="content-header">
                            <h2><i class="fas fa-exchange-alt"></i> 跨環境備份還原</h2>
                        </div>
                        <div style="text-align: center; padding: 40px;">
                            <p>跨環境功能正在開發中...</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- 載入中覆蓋層 -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p id="loadingText">處理中...</p>
            </div>
        </div>

        <!-- 通知容器 -->
        <div id="notifications" class="notifications"></div>
    </div>

    <script>
        // 全局變量
        let currentUser = null;
        let authToken = null;
        let workflows = [];
        let credentials = [];

        // 初始化應用
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 載入完成，開始初始化...');
            
            // 獲取 DOM 元素
            const loginPage = document.getElementById('loginPage');
            const mainPage = document.getElementById('mainPage');
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const currentUserSpan = document.getElementById('currentUser');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            console.log('DOM 元素獲取結果:', {
                loginPage: !!loginPage,
                mainPage: !!mainPage,
                loginForm: !!loginForm,
                logoutBtn: !!logoutBtn,
                currentUserSpan: !!currentUserSpan
            });
            
            // 檢查登入狀態
            checkLoginStatus();
            
            // 設置事件監聽器
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // 標籤頁切換
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
            
            // 重新整理按鈕
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', loadInitialData);
            }

            // 全選/取消全選按鈕
            const selectAllWorkflowsBtn = document.getElementById('selectAllWorkflows');
            const deselectAllWorkflowsBtn = document.getElementById('deselectAllWorkflows');
            const selectAllCredentialsBtn = document.getElementById('selectAllCredentials');
            const deselectAllCredentialsBtn = document.getElementById('deselectAllCredentials');

            if (selectAllWorkflowsBtn) {
                selectAllWorkflowsBtn.addEventListener('click', () => selectAllWorkflows(true));
            }
            if (deselectAllWorkflowsBtn) {
                deselectAllWorkflowsBtn.addEventListener('click', () => selectAllWorkflows(false));
            }
            if (selectAllCredentialsBtn) {
                selectAllCredentialsBtn.addEventListener('click', () => selectAllCredentials(true));
            }
            if (deselectAllCredentialsBtn) {
                deselectAllCredentialsBtn.addEventListener('click', () => selectAllCredentials(false));
            }

            // 智能關聯開關事件
            const smartToggle = document.getElementById('smartSelectionToggle');
            if (smartToggle) {
                smartToggle.addEventListener('change', handleSmartToggleChange);
            }

            // 鍵盤快捷鍵
            document.addEventListener('keydown', handleKeyboardShortcuts);
        });
        
        // 檢查登入狀態
        function checkLoginStatus() {
            console.log('檢查登入狀態...');
            
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken && savedUser) {
                console.log('找到保存的登入信息');
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                showMainPage();
                loadInitialData();
            } else {
                console.log('沒有找到登入信息，顯示登入頁面');
                showLoginPage();
            }
        }
        
        // 顯示登入頁面
        function showLoginPage() {
            console.log('顯示登入頁面');
            const loginPage = document.getElementById('loginPage');
            const mainPage = document.getElementById('mainPage');
            
            if (loginPage) loginPage.classList.remove('hidden');
            if (mainPage) mainPage.classList.add('hidden');
        }
        
        // 顯示主頁面
        function showMainPage() {
            console.log('顯示主頁面');
            const loginPage = document.getElementById('loginPage');
            const mainPage = document.getElementById('mainPage');
            const currentUserSpan = document.getElementById('currentUser');
            
            if (loginPage) loginPage.classList.add('hidden');
            if (mainPage) mainPage.classList.remove('hidden');
            if (currentUserSpan && currentUser) {
                currentUserSpan.textContent = currentUser.username;
            }
        }
        
        // 處理登入
        async function handleLogin(e) {
            e.preventDefault();
            console.log('處理登入...');
            
            const formData = new FormData(e.target);
            const loginData = {
                username: formData.get('username'),
                password: formData.get('password')
            };
            
            try {
                showLoading('登入中...');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    authToken = result.token;
                    currentUser = result.user;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showMainPage();
                    loadInitialData();
                    showNotification('登入成功', 'success');
                } else {
                    showNotification(result.error || '登入失敗', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('登入失敗，請檢查網路連接', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // 處理登出
        function handleLogout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showLoginPage();
            showNotification('已登出', 'info');
        }
        
        // 載入初始數據
        async function loadInitialData() {
            if (!authToken) return;
            
            try {
                showLoading('載入數據中...');
                
                const [workflowsResponse, credentialsResponse] = await Promise.all([
                    fetch('/api/n8n/workflows', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch('/api/n8n/credentials', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                workflows = await workflowsResponse.json();
                credentials = await credentialsResponse.json();
                
                renderWorkflowsList();
                renderCredentialsList();
                
                showNotification('數據載入完成', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('載入數據失敗', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // 渲染 workflows 列表
        function renderWorkflowsList() {
            const container = document.getElementById('workflowsList');
            const countElement = document.getElementById('workflowCount');
            
            if (!container || !countElement) return;
            
            countElement.textContent = workflows.length;
            
            if (workflows.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">沒有找到 workflows</div>';
                return;
            }
            
            container.innerHTML = workflows.map(workflow => {
                const relatedCredentialIds = workflow.relatedCredentialIds || [];
                const relatedCount = relatedCredentialIds.length;
                
                // 獲取相關憑證的名稱用於提示
                const relatedCredentialNames = relatedCredentialIds
                    .map(id => {
                        const credential = credentials.find(c => c.id === id);
                        return credential ? credential.name : `ID: ${id}`;
                    })
                    .join(', ');
                
                const tooltipText = relatedCount > 0 
                    ? `選中此 workflow 將自動選中以下憑證：\n${relatedCredentialNames}`
                    : '此 workflow 不使用任何憑證';
                
                return `
                    <div class="item-checkbox workflow-item" id="workflow-item-${workflow.id}"
                         onmouseenter="highlightRelatedCredentials('${workflow.id}', true)"
                         onmouseleave="highlightRelatedCredentials('${workflow.id}', false)">
                        <input type="checkbox" id="workflow-${workflow.id}" value="${workflow.id}" data-type="workflow"
                               data-related-credentials="${relatedCredentialIds.join(',')}"
                               onchange="handleWorkflowSelection(this)">
                        <div class="item-info">
                            <div class="item-name">
                                ${workflow.name}
                                ${relatedCount > 0 ? `<span class="related-indicator" title="${tooltipText}">🔗${relatedCount}</span>` : ''}
                            </div>
                            <div class="item-details">
                                <span class="item-status ${workflow.active ? 'status-active' : 'status-inactive'}">
                                    <i class="fas ${workflow.active ? 'fa-play' : 'fa-pause'}"></i>
                                    ${workflow.active ? '啟用' : '停用'}
                                </span>
                                ${workflow.tags ? workflow.tags.map(tag => `<span class="item-tag">${tag}</span>`).join('') : ''}
                                <span class="related-credentials-info">相關憑證: ${relatedCount}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 初始化後更新計數
            updateSelectionCounts();
        }
        
        // 渲染 credentials 列表
        function renderCredentialsList() {
            const container = document.getElementById('credentialsList');
            const countElement = document.getElementById('credentialCount');
            
            if (!container || !countElement) return;
            
            countElement.textContent = credentials.length;
            
            if (credentials.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">沒有找到 credentials</div>';
                return;
            }
            
            container.innerHTML = credentials.map(credential => `
                <div class="item-checkbox" id="credential-item-${credential.id}">
                    <input type="checkbox" id="credential-${credential.id}" value="${credential.id}" data-type="credential">
                    <div class="item-info">
                        <div class="item-name">${credential.name}</div>
                        <div class="item-details">
                            <span>類型: ${credential.type}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 智能關聯：勾選 workflow 時自動勾選其所用 credentials
        function handleWorkflowSelection(workflowCheckbox) {
            const isChecked = workflowCheckbox.checked;
            const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
            
            // 檢查智能關聯開關是否啟用
            const smartToggle = document.getElementById('smartSelectionToggle');
            const smartSelectionEnabled = smartToggle ? smartToggle.checked : true;
            
            if (!relatedCredentialIds || !smartSelectionEnabled) {
                updateSelectionCounts();
                return;
            }

            const credentialIds = relatedCredentialIds.split(',').filter(id => id.trim());
            
            credentialIds.forEach(credentialId => {
                const credentialCheckbox = document.getElementById(`credential-${credentialId}`);
                const credentialItem = document.getElementById(`credential-item-${credentialId}`);
                
                if (!credentialCheckbox) return;

                if (isChecked) {
                    // 勾選 workflow 時，自動勾選相關的 credentials
                    credentialCheckbox.checked = true;
                    if (credentialItem) {
                        credentialItem.classList.add('auto-selected');
                        // 添加視覺提示動畫
                        credentialItem.style.animation = 'highlightAutoSelect 0.5s ease';
                        setTimeout(() => {
                            credentialItem.style.animation = '';
                        }, 500);
                    }
                } else {
                    // 取消勾選 workflow 時，檢查是否還有其他 workflow 使用這個 credential
                    const stillNeeded = isCredentialStillNeeded(credentialId);
                    if (!stillNeeded) {
                        credentialCheckbox.checked = false;
                        if (credentialItem) {
                            credentialItem.classList.remove('auto-selected');
                            // 添加取消選中的動畫
                            credentialItem.style.animation = 'highlightAutoDeselect 0.5s ease';
                            setTimeout(() => {
                                credentialItem.style.animation = '';
                            }, 500);
                        }
                    }
                }
            });
            
            // 顯示提示信息（只在有實際操作時顯示）
            if (credentialIds.length > 0) {
                const action = isChecked ? '選中' : '取消選中';
                showSmartSelectionNotification(`已自動${action}相關憑證`, 'info');
            }
            
            // 更新選中計數
            updateSelectionCounts();
        }

        // 判斷某 credential 是否仍被其他已選 workflow 需要
        function isCredentialStillNeeded(credentialId) {
            const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked');
            for (const wf of selectedWorkflows) {
                const ids = (wf.dataset.relatedCredentials || '').split(',');
                if (ids.includes(credentialId)) return true;
            }
            return false;
        }

        // 更新選中項目計數
        function updateSelectionCounts() {
            const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked').length;
            const selectedCredentials = document.querySelectorAll('input[data-type="credential"]:checked').length;
            const autoSelectedCredentials = document.querySelectorAll('.item-checkbox.auto-selected input:checked').length;
            
            // 更新摘要面板
            const summaryPanel = document.getElementById('selectionSummary');
            const selectedWorkflowsCountEl = document.getElementById('selectedWorkflowsCount');
            const selectedCredentialsCountEl = document.getElementById('selectedCredentialsCount');
            const autoSelectedCountEl = document.getElementById('autoSelectedCount');
            const totalSelectedCountEl = document.getElementById('totalSelectedCount');
            
            if (summaryPanel && selectedWorkflowsCountEl && selectedCredentialsCountEl && autoSelectedCountEl && totalSelectedCountEl) {
                const totalSelected = selectedWorkflows + selectedCredentials;
                
                if (totalSelected > 0) {
                    summaryPanel.style.display = 'block';
                    selectedWorkflowsCountEl.textContent = selectedWorkflows;
                    selectedCredentialsCountEl.textContent = selectedCredentials;
                    autoSelectedCountEl.textContent = `(${autoSelectedCredentials} 個自動選中)`;
                    totalSelectedCountEl.textContent = totalSelected;
                } else {
                    summaryPanel.style.display = 'none';
                }
            }
            
            // 更新按鈕文字顯示選中數量
            const backupBtn = document.getElementById('startBackupBtn');
            if (backupBtn) {
                const totalSelected = selectedWorkflows + selectedCredentials;
                if (totalSelected > 0) {
                    backupBtn.innerHTML = `<i class="fas fa-upload"></i> 開始備份 (${selectedWorkflows} 個 Workflows, ${selectedCredentials} 個 Credentials)`;
                    backupBtn.disabled = false;
                    backupBtn.classList.add('ready');
                } else {
                    backupBtn.innerHTML = `<i class="fas fa-upload"></i> 開始備份`;
                    backupBtn.disabled = true;
                    backupBtn.classList.remove('ready');
                }
            }
        }

        // 顯示智能選擇通知（不干擾用戶的輕量提示）
        function showSmartSelectionNotification(message, type = 'info') {
            // 創建一個輕量級的提示，不會像普通通知那樣持續顯示
            const notification = document.createElement('div');
            notification.className = `smart-notification ${type}`;
            notification.textContent = message;
            
            const container = document.getElementById('notifications');
            if (container) {
                container.appendChild(notification);
                
                // 更短的顯示時間，不干擾用戶
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        notification.remove();
                    }, 200);
                }, 1500);
            }
        }

        // 高亮相關憑證
        function highlightRelatedCredentials(workflowId, highlight) {
            const workflowCheckbox = document.getElementById(`workflow-${workflowId}`);
            if (!workflowCheckbox) return;
            
            const relatedCredentialIds = workflowCheckbox.dataset.relatedCredentials;
            if (!relatedCredentialIds) return;
            
            const credentialIds = relatedCredentialIds.split(',').filter(id => id.trim());
            
            credentialIds.forEach(credentialId => {
                const credentialItem = document.getElementById(`credential-item-${credentialId}`);
                if (credentialItem) {
                    if (highlight) {
                        credentialItem.classList.add('related-highlight');
                    } else {
                        credentialItem.classList.remove('related-highlight');
                    }
                }
            });
        }

        // 全選/取消全選功能增強
        function selectAllWorkflows(select) {
            const checkboxes = document.querySelectorAll('input[data-type="workflow"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
                handleWorkflowSelection(checkbox);
            });
        }

        function selectAllCredentials(select) {
            const checkboxes = document.querySelectorAll('input[data-type="credential"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
                // 移除自動選中標記，因為這是手動全選
                const credentialItem = document.getElementById(`credential-item-${checkbox.value}`);
                if (credentialItem && !select) {
                    credentialItem.classList.remove('auto-selected');
                }
            });
            updateSelectionCounts();
        }

        // 處理智能關聯開關變化
        function handleSmartToggleChange() {
            const smartToggle = document.getElementById('smartSelectionToggle');
            const isEnabled = smartToggle.checked;
            
            if (!isEnabled) {
                // 關閉智能關聯時，清除所有自動選中標記
                document.querySelectorAll('.item-checkbox.auto-selected').forEach(item => {
                    item.classList.remove('auto-selected');
                });
                showSmartSelectionNotification('智能關聯已關閉', 'info');
            } else {
                // 開啟智能關聯時，重新應用智能選擇
                const selectedWorkflows = document.querySelectorAll('input[data-type="workflow"]:checked');
                selectedWorkflows.forEach(workflowCheckbox => {
                    handleWorkflowSelection(workflowCheckbox);
                });
                showSmartSelectionNotification('智能關聯已開啟', 'info');
            }
            
            updateSelectionCounts();
        }

        // 鍵盤快捷鍵處理
        function handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + S: 切換智能關聯
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const smartToggle = document.getElementById('smartSelectionToggle');
                if (smartToggle) {
                    smartToggle.checked = !smartToggle.checked;
                    handleSmartToggleChange();
                }
            }
            
            // Ctrl/Cmd + A: 全選 workflows
            if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.shiftKey) {
                e.preventDefault();
                selectAllWorkflows(true);
            }
            
            // Ctrl/Cmd + D: 取消全選
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                selectAllWorkflows(false);
                selectAllCredentials(false);
            }
        }
        
        // 切換標籤頁
        function switchTab(tabName) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        // 顯示載入中
        function showLoading(text = '載入中...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (loadingText) loadingText.textContent = text;
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }
        
        // 隱藏載入中
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }
        
        // 顯示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            const container = document.getElementById('notifications');
            if (container) {
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }
    </script>
</body>
</html>