<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ†‘è­‰ç®¡ç†å™¨</title>
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="credential-manager">
        <h2>ğŸ” æ•æ„Ÿæ†‘è­‰ç®¡ç†</h2>
        
        <div class="credential-mapping">
            <h3>æ†‘è­‰æ˜ å°„é…ç½®</h3>
            <p>å°‡å‚™ä»½ä¸­çš„æ•æ„Ÿæ†‘è­‰æ˜ å°„åˆ°ç›®æ¨™ç’°å¢ƒä¸­çš„ç¾æœ‰æ†‘è­‰</p>
            
            <div id="credentialMappings">
                <!-- å‹•æ…‹ç”Ÿæˆçš„æ˜ å°„é…ç½® -->
            </div>
            
            <div class="mapping-actions">
                <button id="addMappingBtn" class="btn btn-outline">
                    <i class="fas fa-plus"></i> æ·»åŠ æ˜ å°„
                </button>
                <button id="autoDetectBtn" class="btn btn-primary">
                    <i class="fas fa-magic"></i> è‡ªå‹•æª¢æ¸¬
                </button>
            </div>
        </div>
        
        <div class="restore-options">
            <h3>é‚„åŸé¸é …</h3>
            
            <div class="option-group">
                <label>
                    <input type="radio" name="sensitiveMode" value="skip" checked>
                    <span>è·³éæ•æ„Ÿæ†‘è­‰ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰</span>
                </label>
                <label>
                    <input type="radio" name="sensitiveMode" value="map">
                    <span>ä½¿ç”¨æ†‘è­‰æ˜ å°„</span>
                </label>
                <label>
                    <input type="radio" name="sensitiveMode" value="force">
                    <span>å¼·åˆ¶é‚„åŸï¼ˆâš ï¸ é«˜é¢¨éšªï¼‰</span>
                </label>
            </div>
            
            <div class="warning-box" id="forceWarning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>è­¦å‘Šï¼š</strong>å¼·åˆ¶é‚„åŸæ•æ„Ÿæ†‘è­‰å¯èƒ½å°è‡´å®‰å…¨é¢¨éšªã€‚
                è«‹ç¢ºä¿ä½ äº†è§£ç›¸é—œé¢¨éšªä¸¦åœ¨å®‰å…¨ç’°å¢ƒä¸­æ“ä½œã€‚
            </div>
        </div>
        
        <div class="actions">
            <button id="saveConfigBtn" class="btn btn-success">
                <i class="fas fa-save"></i> ä¿å­˜é…ç½®
            </button>
            <button id="testConnectionBtn" class="btn btn-outline">
                <i class="fas fa-plug"></i> æ¸¬è©¦é€£æ¥
            </button>
        </div>
    </div>

    <script>
        // æ†‘è­‰æ˜ å°„ç®¡ç†
        let credentialMappings = {};
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCredentialMappings();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // æ•æ„Ÿæ¨¡å¼åˆ‡æ›
            document.querySelectorAll('input[name="sensitiveMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const forceWarning = document.getElementById('forceWarning');
                    if (this.value === 'force') {
                        forceWarning.style.display = 'block';
                    } else {
                        forceWarning.style.display = 'none';
                    }
                });
            });
            
            // æ·»åŠ æ˜ å°„
            document.getElementById('addMappingBtn').addEventListener('click', addCredentialMapping);
            
            // è‡ªå‹•æª¢æ¸¬
            document.getElementById('autoDetectBtn').addEventListener('click', autoDetectCredentials);
            
            // ä¿å­˜é…ç½®
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfiguration);
            
            // æ¸¬è©¦é€£æ¥
            document.getElementById('testConnectionBtn').addEventListener('click', testConnections);
        }
        
        function addCredentialMapping() {
            const container = document.getElementById('credentialMappings');
            const mappingId = Date.now();
            
            const mappingDiv = document.createElement('div');
            mappingDiv.className = 'credential-mapping-item';
            mappingDiv.innerHTML = `
                <div class="mapping-row">
                    <div class="mapping-field">
                        <label>å‚™ä»½æ†‘è­‰ ID</label>
                        <input type="text" class="source-credential" placeholder="è¼¸å…¥å‚™ä»½ä¸­çš„æ†‘è­‰ ID">
                    </div>
                    <div class="mapping-arrow">â†’</div>
                    <div class="mapping-field">
                        <label>ç›®æ¨™æ†‘è­‰ ID</label>
                        <input type="text" class="target-credential" placeholder="è¼¸å…¥ç›®æ¨™ç’°å¢ƒä¸­çš„æ†‘è­‰ ID">
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeMapping(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(mappingDiv);
        }
        
        function removeMapping(button) {
            button.closest('.credential-mapping-item').remove();
        }
        
        async function autoDetectCredentials() {
            try {
                // ç²å–ç›®æ¨™ç’°å¢ƒä¸­çš„æ†‘è­‰åˆ—è¡¨
                const response = await fetch('/api/n8n/credentials');
                const credentials = await response.json();
                
                // é¡¯ç¤ºæª¢æ¸¬åˆ°çš„æ†‘è­‰
                showCredentialSuggestions(credentials);
                
            } catch (error) {
                console.error('è‡ªå‹•æª¢æ¸¬å¤±æ•—:', error);
                alert('è‡ªå‹•æª¢æ¸¬å¤±æ•—ï¼Œè«‹æ‰‹å‹•é…ç½®');
            }
        }
        
        function showCredentialSuggestions(credentials) {
            const suggestions = credentials.filter(cred => 
                ['googleSheetsOAuth2Api', 'googleDriveOAuth2Api'].includes(cred.type)
            );
            
            if (suggestions.length > 0) {
                const message = `æª¢æ¸¬åˆ° ${suggestions.length} å€‹å¯ç”¨æ†‘è­‰ï¼š\n` +
                    suggestions.map(c => `${c.name} (${c.id})`).join('\n') +
                    '\n\næ˜¯å¦è‡ªå‹•å‰µå»ºæ˜ å°„ï¼Ÿ';
                
                if (confirm(message)) {
                    // è‡ªå‹•å‰µå»ºæ˜ å°„å»ºè­°
                    suggestions.forEach(cred => {
                        // é€™è£¡å¯ä»¥æ·»åŠ æ™ºèƒ½åŒ¹é…é‚è¼¯
                    });
                }
            } else {
                alert('æœªæª¢æ¸¬åˆ°ç›¸é—œæ†‘è­‰ï¼Œè«‹æ‰‹å‹•é…ç½®');
            }
        }
        
        function saveConfiguration() {
            const mappings = {};
            const sensitiveMode = document.querySelector('input[name="sensitiveMode"]:checked').value;
            
            // æ”¶é›†æ˜ å°„é…ç½®
            document.querySelectorAll('.credential-mapping-item').forEach(item => {
                const source = item.querySelector('.source-credential').value;
                const target = item.querySelector('.target-credential').value;
                
                if (source && target) {
                    mappings[source] = target;
                }
            });
            
            const config = {
                sensitiveMode,
                credentialMappings: mappings,
                timestamp: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('credentialConfig', JSON.stringify(config));
            
            alert('é…ç½®å·²ä¿å­˜');
        }
        
        function loadCredentialMappings() {
            const saved = localStorage.getItem('credentialConfig');
            if (saved) {
                const config = JSON.parse(saved);
                
                // æ¢å¾©æ•æ„Ÿæ¨¡å¼è¨­ç½®
                const modeRadio = document.querySelector(`input[name="sensitiveMode"][value="${config.sensitiveMode}"]`);
                if (modeRadio) {
                    modeRadio.checked = true;
                }
                
                // æ¢å¾©æ˜ å°„é…ç½®
                Object.entries(config.credentialMappings || {}).forEach(([source, target]) => {
                    addCredentialMapping();
                    const lastMapping = document.querySelector('.credential-mapping-item:last-child');
                    lastMapping.querySelector('.source-credential').value = source;
                    lastMapping.querySelector('.target-credential').value = target;
                });
            }
        }
        
        async function testConnections() {
            // æ¸¬è©¦ç›®æ¨™ç’°å¢ƒä¸­çš„æ†‘è­‰æ˜¯å¦å¯ç”¨
            const mappings = {};
            document.querySelectorAll('.credential-mapping-item').forEach(item => {
                const target = item.querySelector('.target-credential').value;
                if (target) {
                    mappings[target] = target;
                }
            });
            
            for (const credId of Object.values(mappings)) {
                try {
                    const response = await fetch(`/api/n8n/credentials/${credId}`);
                    if (response.ok) {
                        console.log(`âœ… æ†‘è­‰ ${credId} å¯ç”¨`);
                    } else {
                        console.log(`âŒ æ†‘è­‰ ${credId} ä¸å¯ç”¨`);
                    }
                } catch (error) {
                    console.log(`âŒ æ†‘è­‰ ${credId} æ¸¬è©¦å¤±æ•—:`, error);
                }
            }
            
            alert('é€£æ¥æ¸¬è©¦å®Œæˆï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°');
        }
        
        // å°å‡ºé…ç½®ä¾›é‚„åŸåŠŸèƒ½ä½¿ç”¨
        window.getCredentialConfig = function() {
            const saved = localStorage.getItem('credentialConfig');
            return saved ? JSON.parse(saved) : null;
        };
    </script>
</body>
</html>