<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>憑證管理器</title>
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="credential-manager">
        <h2>🔐 敏感憑證管理</h2>
        
        <div class="credential-mapping">
            <h3>憑證映射配置</h3>
            <p>將備份中的敏感憑證映射到目標環境中的現有憑證</p>
            
            <div id="credentialMappings">
                <!-- 動態生成的映射配置 -->
            </div>
            
            <div class="mapping-actions">
                <button id="addMappingBtn" class="btn btn-outline">
                    <i class="fas fa-plus"></i> 添加映射
                </button>
                <button id="autoDetectBtn" class="btn btn-primary">
                    <i class="fas fa-magic"></i> 自動檢測
                </button>
            </div>
        </div>
        
        <div class="restore-options">
            <h3>還原選項</h3>
            
            <div class="option-group">
                <label>
                    <input type="radio" name="sensitiveMode" value="skip" checked>
                    <span>跳過敏感憑證（安全模式）</span>
                </label>
                <label>
                    <input type="radio" name="sensitiveMode" value="map">
                    <span>使用憑證映射</span>
                </label>
                <label>
                    <input type="radio" name="sensitiveMode" value="force">
                    <span>強制還原（⚠️ 高風險）</span>
                </label>
            </div>
            
            <div class="warning-box" id="forceWarning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>警告：</strong>強制還原敏感憑證可能導致安全風險。
                請確保你了解相關風險並在安全環境中操作。
            </div>
        </div>
        
        <div class="actions">
            <button id="saveConfigBtn" class="btn btn-success">
                <i class="fas fa-save"></i> 保存配置
            </button>
            <button id="testConnectionBtn" class="btn btn-outline">
                <i class="fas fa-plug"></i> 測試連接
            </button>
        </div>
    </div>

    <script>
        // 憑證映射管理
        let credentialMappings = {};
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCredentialMappings();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // 敏感模式切換
            document.querySelectorAll('input[name="sensitiveMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const forceWarning = document.getElementById('forceWarning');
                    if (this.value === 'force') {
                        forceWarning.style.display = 'block';
                    } else {
                        forceWarning.style.display = 'none';
                    }
                });
            });
            
            // 添加映射
            document.getElementById('addMappingBtn').addEventListener('click', addCredentialMapping);
            
            // 自動檢測
            document.getElementById('autoDetectBtn').addEventListener('click', autoDetectCredentials);
            
            // 保存配置
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfiguration);
            
            // 測試連接
            document.getElementById('testConnectionBtn').addEventListener('click', testConnections);
        }
        
        function addCredentialMapping() {
            const container = document.getElementById('credentialMappings');
            const mappingId = Date.now();
            
            const mappingDiv = document.createElement('div');
            mappingDiv.className = 'credential-mapping-item';
            mappingDiv.innerHTML = `
                <div class="mapping-row">
                    <div class="mapping-field">
                        <label>備份憑證 ID</label>
                        <input type="text" class="source-credential" placeholder="輸入備份中的憑證 ID">
                    </div>
                    <div class="mapping-arrow">→</div>
                    <div class="mapping-field">
                        <label>目標憑證 ID</label>
                        <input type="text" class="target-credential" placeholder="輸入目標環境中的憑證 ID">
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeMapping(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(mappingDiv);
        }
        
        function removeMapping(button) {
            button.closest('.credential-mapping-item').remove();
        }
        
        async function autoDetectCredentials() {
            try {
                // 獲取目標環境中的憑證列表
                const response = await fetch('/api/n8n/credentials');
                const credentials = await response.json();
                
                // 顯示檢測到的憑證
                showCredentialSuggestions(credentials);
                
            } catch (error) {
                console.error('自動檢測失敗:', error);
                alert('自動檢測失敗，請手動配置');
            }
        }
        
        function showCredentialSuggestions(credentials) {
            const suggestions = credentials.filter(cred => 
                ['googleSheetsOAuth2Api', 'googleDriveOAuth2Api'].includes(cred.type)
            );
            
            if (suggestions.length > 0) {
                const message = `檢測到 ${suggestions.length} 個可用憑證：\n` +
                    suggestions.map(c => `${c.name} (${c.id})`).join('\n') +
                    '\n\n是否自動創建映射？';
                
                if (confirm(message)) {
                    // 自動創建映射建議
                    suggestions.forEach(cred => {
                        // 這裡可以添加智能匹配邏輯
                    });
                }
            } else {
                alert('未檢測到相關憑證，請手動配置');
            }
        }
        
        function saveConfiguration() {
            const mappings = {};
            const sensitiveMode = document.querySelector('input[name="sensitiveMode"]:checked').value;
            
            // 收集映射配置
            document.querySelectorAll('.credential-mapping-item').forEach(item => {
                const source = item.querySelector('.source-credential').value;
                const target = item.querySelector('.target-credential').value;
                
                if (source && target) {
                    mappings[source] = target;
                }
            });
            
            const config = {
                sensitiveMode,
                credentialMappings: mappings,
                timestamp: new Date().toISOString()
            };
            
            // 保存到本地存儲
            localStorage.setItem('credentialConfig', JSON.stringify(config));
            
            alert('配置已保存');
        }
        
        function loadCredentialMappings() {
            const saved = localStorage.getItem('credentialConfig');
            if (saved) {
                const config = JSON.parse(saved);
                
                // 恢復敏感模式設置
                const modeRadio = document.querySelector(`input[name="sensitiveMode"][value="${config.sensitiveMode}"]`);
                if (modeRadio) {
                    modeRadio.checked = true;
                }
                
                // 恢復映射配置
                Object.entries(config.credentialMappings || {}).forEach(([source, target]) => {
                    addCredentialMapping();
                    const lastMapping = document.querySelector('.credential-mapping-item:last-child');
                    lastMapping.querySelector('.source-credential').value = source;
                    lastMapping.querySelector('.target-credential').value = target;
                });
            }
        }
        
        async function testConnections() {
            // 測試目標環境中的憑證是否可用
            const mappings = {};
            document.querySelectorAll('.credential-mapping-item').forEach(item => {
                const target = item.querySelector('.target-credential').value;
                if (target) {
                    mappings[target] = target;
                }
            });
            
            for (const credId of Object.values(mappings)) {
                try {
                    const response = await fetch(`/api/n8n/credentials/${credId}`);
                    if (response.ok) {
                        console.log(`✅ 憑證 ${credId} 可用`);
                    } else {
                        console.log(`❌ 憑證 ${credId} 不可用`);
                    }
                } catch (error) {
                    console.log(`❌ 憑證 ${credId} 測試失敗:`, error);
                }
            }
            
            alert('連接測試完成，請查看控制台');
        }
        
        // 導出配置供還原功能使用
        window.getCredentialConfig = function() {
            const saved = localStorage.getItem('credentialConfig');
            return saved ? JSON.parse(saved) : null;
        };
    </script>
</body>
</html>